{% comment %}
  Size Chart Button Block
  Displays a customizable button that opens a modal with the product's size chart
{% endcomment %}

<style>
  .size-chart-button-wrapper {
    display: flex;
    justify-content: {{ block.settings.button_alignment }};
    margin: 10px 0;
  }

  .size-chart-button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    font-size: {{ block.settings.font_size }}px;
    font-weight: 500;
    color: {{ block.settings.text_color }};
    background-color: {{ block.settings.background_color }};
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: opacity 0.2s ease, transform 0.1s ease;
  }

  .size-chart-button:hover {
    opacity: 0.85;
  }

  .size-chart-button:active {
    transform: scale(0.98);
  }

  .size-chart-button svg {
    width: {{ block.settings.font_size }}px;
    height: {{ block.settings.font_size }}px;
    flex-shrink: 0;
  }

  /* Modal Styles - Portal to body */
  .size-chart-modal-overlay {
    all: initial;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    margin: 0 !important;
    background-color: rgba(0, 0, 0, 0.5) !important;
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2147483647 !important;
    padding: 20px;
    box-sizing: border-box !important;
    isolation: isolate;
    pointer-events: auto;
  }

  .size-chart-modal-overlay.active {
    display: flex !important;
  }

  .size-chart-modal-overlay * {
    box-sizing: border-box;
  }

  .size-chart-modal {
    position: relative;
    background: #ffffff !important;
    border-radius: 12px;
    max-width: 90vw;
    max-height: 90vh;
    width: 800px;
    overflow: hidden;
    transform: scale(0.95);
    transition: transform 0.2s ease;
    display: flex;
    flex-direction: column;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    z-index: 2147483647;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    font-size: 14px;
    line-height: 1.5;
    color: #111827;
  }

  .size-chart-modal-overlay.active .size-chart-modal {
    transform: scale(1);
  }

  /* Header */
  .size-chart-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid #e5e7eb;
    background: #ffffff;
    flex-shrink: 0;
    gap: 16px;
  }

  .size-chart-modal-title {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #111827;
    line-height: 1.4;
    flex: 1;
  }

  .size-chart-header-actions {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  /* Unit Toggle */
  .size-chart-unit-toggle {
    display: flex;
    background: #f3f4f6;
    border-radius: 8px;
    padding: 4px;
    gap: 2px;
  }

  .size-chart-unit-btn {
    padding: 6px 16px;
    border: none;
    background: transparent;
    color: #6b7280;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.15s ease;
    font-family: inherit;
  }

  .size-chart-unit-btn:hover {
    color: #374151;
  }

  .size-chart-unit-btn.active {
    background: #1f2937;
    color: #ffffff;
  }

  .size-chart-modal-close {
    background: transparent;
    border: none;
    padding: 8px;
    cursor: pointer;
    color: #9ca3af;
    border-radius: 6px;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .size-chart-modal-close:hover {
    background: #f3f4f6;
    color: #374151;
  }

  .size-chart-modal-close svg {
    width: 20px;
    height: 20px;
  }

  /* Tabs */
  .size-chart-tabs {
    display: flex;
    border-bottom: 1px solid #e5e7eb;
    padding: 0 24px;
    background: #ffffff;
  }

  .size-chart-tab {
    padding: 14px 4px;
    margin-right: 24px;
    border: none;
    background: transparent;
    color: #6b7280;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all 0.15s ease;
    font-family: inherit;
  }

  .size-chart-tab:hover {
    color: #374151;
  }

  .size-chart-tab.active {
    color: #111827;
    border-bottom-color: #111827;
  }

  /* Modal Body */
  .size-chart-modal-body {
    padding: 0;
    overflow-y: auto;
    flex: 1;
    background: #ffffff;
  }

  .size-chart-tab-content {
    display: none;
    padding: 24px;
  }

  .size-chart-tab-content.active {
    display: block;
  }

  /* Loading & Error States */
  .size-chart-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 40px;
    color: #6b7280;
    gap: 16px;
  }

  .size-chart-loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid #e5e7eb;
    border-top-color: #111827;
    border-radius: 50%;
    animation: size-chart-spin 0.8s linear infinite;
  }

  .size-chart-loading span {
    font-size: 14px;
    color: #6b7280;
  }

  @keyframes size-chart-spin {
    to { transform: rotate(360deg); }
  }

  .size-chart-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 60px 40px;
    color: #dc2626;
  }

  .size-chart-error svg {
    width: 48px;
    height: 48px;
    margin-bottom: 16px;
    color: #fca5a5;
  }

  .size-chart-error p {
    margin: 0;
    font-size: 15px;
    color: #dc2626;
    font-weight: 500;
    line-height: 1.5;
  }

  /* ==========================================
     TABLE DESIGN STYLES
     ========================================== */

  /* Base Table Styles */
  .size-chart-table-wrapper {
    overflow-x: auto;
  }

  .size-chart-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  .size-chart-table th,
  .size-chart-table td {
    padding: 14px 20px;
    text-align: left;
  }

  .size-chart-table td:first-child {
    font-weight: 500;
  }

  /* Design 1: Classic - Clean borders with gray header */
  .table-design-classic .size-chart-table-wrapper {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
  }

  .table-design-classic .size-chart-table th,
  .table-design-classic .size-chart-table td {
    border-bottom: 1px solid #e5e7eb;
    border-right: 1px solid #e5e7eb;
  }

  .table-design-classic .size-chart-table th:last-child,
  .table-design-classic .size-chart-table td:last-child {
    border-right: none;
  }

  .table-design-classic .size-chart-table th {
    background: #f9fafb;
    font-weight: 600;
    color: #374151;
  }

  .table-design-classic .size-chart-table tr:last-child td {
    border-bottom: none;
  }

  .table-design-classic .size-chart-table tbody tr:hover td {
    background: #f9fafb;
  }

  .table-design-classic .size-chart-table td {
    color: #374151;
  }

  .table-design-classic .size-chart-table td:first-child {
    color: #111827;
  }

  /* Design 2: Minimal - Clean with subtle borders */
  .table-design-minimal .size-chart-table-wrapper {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
  }

  .table-design-minimal .size-chart-table th,
  .table-design-minimal .size-chart-table td {
    border-bottom: 1px solid #e5e7eb;
    border-right: 1px solid #e5e7eb;
    padding: 16px 20px;
  }

  .table-design-minimal .size-chart-table th:last-child,
  .table-design-minimal .size-chart-table td:last-child {
    border-right: none;
  }

  .table-design-minimal .size-chart-table th {
    background: #fafafa;
    font-weight: 600;
    color: #6b7280;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .table-design-minimal .size-chart-table tr:last-child td {
    border-bottom: none;
  }

  .table-design-minimal .size-chart-table tbody tr:hover td {
    background: #f9fafb;
  }

  .table-design-minimal .size-chart-table td {
    color: #4b5563;
  }

  .table-design-minimal .size-chart-table td:first-child {
    color: #111827;
    font-weight: 600;
  }

  /* Design 3: Striped - Alternating row colors with borders */
  .table-design-striped .size-chart-table-wrapper {
    border: 1px solid #d1d5db;
    border-radius: 8px;
    overflow: hidden;
  }

  .table-design-striped .size-chart-table th {
    background: #1f2937;
    font-weight: 600;
    color: #ffffff;
    padding: 16px 20px;
    border-right: 1px solid #374151;
    border-bottom: 1px solid #374151;
  }

  .table-design-striped .size-chart-table th:last-child {
    border-right: none;
  }

  .table-design-striped .size-chart-table td {
    border-bottom: 1px solid #e5e7eb;
    border-right: 1px solid #e5e7eb;
    color: #374151;
    padding: 14px 20px;
  }

  .table-design-striped .size-chart-table td:last-child {
    border-right: none;
  }

  .table-design-striped .size-chart-table tr:last-child td {
    border-bottom: none;
  }

  .table-design-striped .size-chart-table tbody tr:nth-child(odd) td {
    background: #f9fafb;
  }

  .table-design-striped .size-chart-table tbody tr:nth-child(even) td {
    background: #ffffff;
  }

  .table-design-striped .size-chart-table tbody tr:hover td {
    background: #e5e7eb;
  }

  .table-design-striped .size-chart-table td:first-child {
    color: #111827;
    font-weight: 600;
  }

  /* Design 4: Modern - Soft cards, rounded header corners, subtle borders */
  .table-design-modern .size-chart-table-wrapper {
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.18);
    overflow: hidden;
    background: #ffffff;
  }

  .table-design-modern .size-chart-table {
    border-collapse: separate;
    border-spacing: 0;
  }

  .table-design-modern .size-chart-table th,
  .table-design-modern .size-chart-table td {
    border-bottom: 1px solid #e5e7eb;
    border-right: 1px solid #e5e7eb;
  }

  .table-design-modern .size-chart-table th:last-child,
  .table-design-modern .size-chart-table td:last-child {
    border-right: none;
  }

  .table-design-modern .size-chart-table th {
    /* Modern solid header (no gradient) */
    background: #111827;
    font-weight: 600;
    color: #ffffff;
    padding: 16px 20px;
    position: relative;
  }

  .table-design-modern .size-chart-table thead tr th:first-child {
    border-top-left-radius: 16px;
  }

  .table-design-modern .size-chart-table thead tr th:last-child {
    border-top-right-radius: 16px;
  }

  .table-design-modern .size-chart-table td {
    padding: 14px 20px;
    color: #111827;
    background: #ffffff;
  }

  .table-design-modern .size-chart-table tr:last-child td:first-child {
    border-bottom-left-radius: 16px;
  }

  .table-design-modern .size-chart-table tr:last-child td:last-child {
    border-bottom-right-radius: 16px;
  }

  .table-design-modern .size-chart-table tbody tr:nth-child(odd) td {
    background: #f9fafb;
  }

  .table-design-modern .size-chart-table tbody tr:hover td {
    background: #eef2ff;
  }

  .table-design-modern .size-chart-table td:first-child {
    font-weight: 600;
  }

  /* Design 5: Elegant - Dark header, refined borders */
  .table-design-elegant .size-chart-table-wrapper {
    border: 2px solid #111827;
    border-radius: 4px;
    overflow: hidden;
  }

  .table-design-elegant .size-chart-table th {
    background: #111827;
    font-weight: 500;
    color: #ffffff;
    padding: 16px 20px;
    border-right: 1px solid #374151;
    border-bottom: 2px solid #111827;
    text-transform: uppercase;
    font-size: 12px;
    letter-spacing: 0.1em;
  }

  .table-design-elegant .size-chart-table th:last-child {
    border-right: none;
  }

  .table-design-elegant .size-chart-table td {
    border-bottom: 1px solid #d1d5db;
    border-right: 1px solid #d1d5db;
    color: #374151;
    padding: 14px 20px;
  }

  .table-design-elegant .size-chart-table td:last-child {
    border-right: none;
  }

  .table-design-elegant .size-chart-table tr:last-child td {
    border-bottom: none;
  }

  .table-design-elegant .size-chart-table tbody tr:hover td {
    background: #f3f4f6;
  }

  .table-design-elegant .size-chart-table td:first-child {
    color: #111827;
    font-weight: 600;
    background: #f9fafb;
    border-right: 1px solid #d1d5db;
  }

  /* How to Measure Tab */
  .size-chart-measure-content {
    display: flex;
    gap: 32px;
    flex-wrap: wrap;
  }

  .size-chart-measure-image {
    flex: 0 0 auto;
    max-width: 300px;
  }

  .size-chart-measure-image img {
    width: 100%;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
  }

  .size-chart-measure-description {
    flex: 1;
    min-width: 250px;
    font-size: 14px;
    line-height: 1.7;
    color: #4b5563;
  }

  .size-chart-measure-description h3 {
    font-size: 16px;
    font-weight: 600;
    color: #111827;
    margin: 0 0 12px 0;
  }

  .size-chart-measure-description p {
    margin: 0 0 16px 0;
  }

  .size-chart-measure-description ul {
    margin: 0;
    padding-left: 20px;
  }

  .size-chart-measure-description li {
    margin-bottom: 8px;
  }

  .size-chart-no-content {
    text-align: center;
    padding: 40px;
    color: #6b7280;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .size-chart-modal-overlay {
      padding: 0;
    }

    .size-chart-modal {
      width: 100%;
      max-width: 100%;
      max-height: 100%;
      height: 100%;
      border-radius: 0;
    }

    .size-chart-modal-header {
      padding: 16px 16px;
      flex-wrap: wrap;
    }

    .size-chart-modal-title {
      font-size: 16px;
      order: 1;
      flex: 0 0 auto;
    }

    .size-chart-header-actions {
      order: 2;
    }

    .size-chart-tabs {
      padding: 0 16px;
    }

    .size-chart-tab {
      padding: 12px 4px;
      margin-right: 16px;
      font-size: 13px;
    }

    .size-chart-tab-content {
      padding: 16px;
    }

    .size-chart-table th,
    .size-chart-table td {
      padding: 12px 14px;
      font-size: 13px;
    }

    .size-chart-unit-btn {
      padding: 6px 12px;
      font-size: 13px;
    }

    .size-chart-measure-content {
      flex-direction: column;
    }

    .size-chart-measure-image {
      max-width: 100%;
    }

    .size-chart-error,
    .size-chart-loading {
      padding: 40px 20px;
    }
  }
</style>

<div class="size-chart-button-wrapper" data-block-id="{{ block.id }}">
  <button 
    type="button" 
    class="size-chart-button"
    data-size-chart-trigger
    data-shop="{{ shop.permanent_domain }}"
    data-product-id="{{ product.id }}"
    data-table-design="{{ block.settings.table_design }}"
    aria-label="{{ block.settings.button_text }}"
  >
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
      <polyline points="7.5 4.21 12 6.81 16.5 4.21"/>
      <polyline points="7.5 19.79 7.5 14.6 3 12"/>
      <polyline points="21 12 16.5 14.6 16.5 19.79"/>
      <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
      <line x1="12" y1="22.08" x2="12" y2="12"/>
    </svg>
    {{ block.settings.button_text }}
  </button>
</div>

<!-- Modal Template -->
<div class="size-chart-modal-overlay" data-size-chart-modal="{{ block.id }}">
  <div class="size-chart-modal" role="dialog" aria-modal="true" aria-labelledby="size-chart-title-{{ block.id }}">
    <div class="size-chart-modal-header">
      <h2 class="size-chart-modal-title" id="size-chart-title-{{ block.id }}" data-size-chart-title>Size Chart</h2>
      <div class="size-chart-header-actions">
        <div class="size-chart-unit-toggle" data-unit-toggle>
          <button type="button" class="size-chart-unit-btn active" data-unit="in">In</button>
          <button type="button" class="size-chart-unit-btn" data-unit="cm">cm</button>
        </div>
        <button type="button" class="size-chart-modal-close" data-size-chart-close aria-label="Close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>
    <div class="size-chart-tabs" data-tabs-container>
      <button type="button" class="size-chart-tab active" data-tab="details">Details</button>
      <button type="button" class="size-chart-tab" data-tab="measure">How to Measure</button>
    </div>
    <div class="size-chart-modal-body" data-size-chart-content>
      <!-- Content will be loaded dynamically -->
    </div>
  </div>
</div>

<script>
  (function() {
    const blockId = "{{ block.id }}";
    const wrapper = document.querySelector(`[data-block-id="${blockId}"]`);
    const button = wrapper?.querySelector('[data-size-chart-trigger]');
    let modal = document.querySelector(`[data-size-chart-modal="${blockId}"]`);
    
    if (!button || !modal) return;

    // Move modal to body to escape stacking contexts
    if (modal.parentElement !== document.body) {
      document.body.appendChild(modal);
    }

    const closeBtn = modal.querySelector('[data-size-chart-close]');
    const contentContainer = modal.querySelector('[data-size-chart-content]');
    const titleElement = modal.querySelector('[data-size-chart-title]');
    const tabsContainer = modal.querySelector('[data-tabs-container]');
    const unitToggle = modal.querySelector('[data-unit-toggle]');

    const shop = button.dataset.shop;
    const productId = button.dataset.productId;
    const tableDesign = button.dataset.tableDesign || 'classic';
    
    let isLoaded = false;
    let templateData = null;
    let currentUnit = 'in';
    let currentTab = 'details';

    // Convert inches to cm
    function inToCm(value) {
      const num = parseFloat(value);
      if (isNaN(num)) return value;
      return (num * 2.54).toFixed(1);
    }

    // Get display value based on unit
    function getDisplayValue(value, unit) {
      if (value === '-' || value === '' || value === null || value === undefined) return '-';
      if (unit === 'cm') {
        return inToCm(value);
      }
      return value;
    }

    // Render loading state
    function renderLoading() {
      contentContainer.innerHTML = `
        <div class="size-chart-tab-content active">
          <div class="size-chart-loading">
            <div class="size-chart-loading-spinner"></div>
            <span>Loading size chart...</span>
          </div>
        </div>
      `;
    }

    // Render error state
    function renderError(message) {
      contentContainer.innerHTML = `
        <div class="size-chart-tab-content active">
          <div class="size-chart-error">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <p>${message || 'No size chart available for this product.'}</p>
          </div>
        </div>
      `;
    }

    // Get unit suffix
    function getUnitSuffix(unit) {
      return unit === 'cm' ? 'cm' : 'In';
    }

    // Render table content
    function renderContent(template, unit = 'in') {
      const { name, columns, rows, guideImage, measureDescription } = template;
      const unitSuffix = getUnitSuffix(unit);

      // Update title
      if (titleElement && name) {
        titleElement.textContent = name;
      }

      let html = '';

      // Details Tab with table design class
      html += `<div class="size-chart-tab-content table-design-${tableDesign} ${currentTab === 'details' ? 'active' : ''}" data-tab-content="details">`;
      
      if (columns && columns.length > 0) {
        html += '<div class="size-chart-table-wrapper">';
        html += '<table class="size-chart-table">';
        
        // Header row
        html += '<thead><tr>';
        columns.forEach((col, index) => {
          let label = col.label || col.name || col;
          // Remove existing unit suffixes like (in), (cm), (In), (Cm) etc.
          const cleanLabel = label.replace(/\s*\((in|cm|In|Cm)\)\s*$/i, '').trim();
          // First column is usually "Size" - no unit suffix
          if (index === 0 && cleanLabel.toLowerCase().includes('size')) {
            html += `<th>${escapeHtml(cleanLabel)}</th>`;
          } else {
            html += `<th>${escapeHtml(cleanLabel)} (${unitSuffix})</th>`;
          }
        });
        html += '</tr></thead>';

        // Body rows
        html += '<tbody>';
        if (rows && rows.length > 0) {
          rows.forEach(row => {
            html += '<tr>';
            columns.forEach((col, index) => {
              const key = col.key || col.name || col;
              let value = row[key] ?? '-';
              // Don't convert the first column (Size)
              const colLabel = col.label || col.name || col;
              if (index === 0 && colLabel.toLowerCase().includes('size')) {
                html += `<td>${escapeHtml(String(value))}</td>`;
              } else {
                html += `<td>${escapeHtml(String(getDisplayValue(value, unit)))}</td>`;
              }
            });
            html += '</tr>';
          });
        }
        html += '</tbody>';
        html += '</table>';
        html += '</div>';
      } else {
        html += '<div class="size-chart-no-content">No size data available.</div>';
      }
      
      html += '</div>';

      // How to Measure Tab
      html += `<div class="size-chart-tab-content ${currentTab === 'measure' ? 'active' : ''}" data-tab-content="measure">`;
      
      if (guideImage || measureDescription) {
        html += '<div class="size-chart-measure-content">';
        
        if (guideImage) {
          html += `
            <div class="size-chart-measure-image">
              <img src="${guideImage}" alt="How to measure" loading="lazy">
            </div>
          `;
        }
        
        if (measureDescription) {
          html += `<div class="size-chart-measure-description">${measureDescription}</div>`;
        }
        
        html += '</div>';
      } else {
        html += '<div class="size-chart-no-content">No measurement guide available for this product.</div>';
      }
      
      html += '</div>';

      contentContainer.innerHTML = html;
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Handle tab switching
    function switchTab(tabName) {
      currentTab = tabName;
      
      // Update tab buttons
      tabsContainer.querySelectorAll('.size-chart-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });
      
      // Update tab content
      contentContainer.querySelectorAll('[data-tab-content]').forEach(content => {
        content.classList.toggle('active', content.dataset.tabContent === tabName);
      });
    }

    // Handle unit switching
    function switchUnit(unit) {
      currentUnit = unit;
      
      // Update unit buttons
      unitToggle.querySelectorAll('.size-chart-unit-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.unit === unit);
      });
      
      // Re-render content with new unit
      if (templateData) {
        renderContent(templateData, unit);
      }
    }

    // Fetch size chart data
    async function fetchSizeChart() {
      if (isLoaded && templateData) {
        renderContent(templateData, currentUnit);
        return;
      }

      renderLoading();

      try {
        const apiUrl = `/apps/size-guide/api/storefront/size-chart?shop=${encodeURIComponent(shop)}&productId=${encodeURIComponent(productId)}`;
        
        const response = await fetch(apiUrl, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        });

        const data = await response.json();

        if (!response.ok || !data.hasTemplate) {
          renderError(data.error || 'No size chart available for this product.');
          return;
        }

        templateData = data.template;
        isLoaded = true;
        renderContent(templateData, currentUnit);
      } catch (error) {
        console.error('Error fetching size chart:', error);
        renderError('Failed to load size chart. Please try again.');
      }
    }

    // Open modal
    function openModal() {
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
      fetchSizeChart();
      closeBtn?.focus();
    }

    // Close modal
    function closeModal() {
      modal.classList.remove('active');
      document.body.style.overflow = '';
      button.focus();
    }

    // Event listeners
    button.addEventListener('click', openModal);
    closeBtn?.addEventListener('click', closeModal);

    // Tab switching
    tabsContainer.addEventListener('click', (e) => {
      const tab = e.target.closest('[data-tab]');
      if (tab) {
        switchTab(tab.dataset.tab);
      }
    });

    // Unit switching
    unitToggle.addEventListener('click', (e) => {
      const unitBtn = e.target.closest('[data-unit]');
      if (unitBtn) {
        switchUnit(unitBtn.dataset.unit);
      }
    });

    // Close on overlay click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('active')) {
        closeModal();
      }
    });

    // Theme editor: close modal when section/block is reloaded or settings change
    function handleShopifyEditorEvent() {
      if (modal.classList.contains('active')) {
        closeModal();
      }
    }

    document.addEventListener('shopify:section:load', handleShopifyEditorEvent);
    document.addEventListener('shopify:section:select', handleShopifyEditorEvent);
    document.addEventListener('shopify:block:select', handleShopifyEditorEvent);
    document.addEventListener('shopify:block:deselect', handleShopifyEditorEvent);
  })();
</script>

{% schema %}
{
  "name": "Size Chart Button",
  "target": "section",
  "enabled_on": {
    "templates": ["product"]
  },
  "settings": [
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Size Guide"
    },
    {
      "type": "select",
      "id": "button_alignment",
      "label": "Alignment",
      "options": [
        { "value": "flex-start", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "flex-end", "label": "Right" }
      ],
      "default": "flex-start"
    },
    {
      "type": "select",
      "id": "table_design",
      "label": "Table design",
      "options": [
        { "value": "classic", "label": "Classic" },
        { "value": "minimal", "label": "Minimal" },
        { "value": "striped", "label": "Striped" },
        { "value": "modern", "label": "Modern" },
        { "value": "elegant", "label": "Elegant" }
      ],
      "default": "classic"
    },
    {
      "type": "range",
      "id": "font_size",
      "label": "Font size",
      "min": 10,
      "max": 24,
      "step": 1,
      "default": 14,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#111111"
    }
  ]
}
{% endschema %}
