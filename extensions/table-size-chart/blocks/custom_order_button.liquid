{% comment %}
  Custom Order Button Block
  Displays a customizable button that opens a modal with custom measurement form
  Fetches measurement fields from the tailor template assigned to the current product
{% endcomment %}

<style>
  .custom-order-button-wrapper {
    display: none;
    margin: 10px 0;
  }

  .custom-order-button-wrapper.has-template {
    display: flex;
  }

  .custom-order-button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: opacity 0.2s ease, transform 0.1s ease;
    font-weight: 500;
    font-size: 14px;
    border-radius: 0;
  }

  .custom-order-button:hover {
    opacity: 0.85;
  }

  .custom-order-button:active {
    transform: scale(0.98);
  }

  .custom-order-button svg {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }

  /* Modal Styles - Portal to body */
  .custom-order-modal-overlay {
    all: initial;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    margin: 0 !important;
    background-color: rgba(0, 0, 0, 0.5) !important;
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2147483647 !important;
    padding: 16px;
    box-sizing: border-box !important;
    isolation: isolate;
    pointer-events: auto;
  }

  .custom-order-modal-overlay.active {
    display: flex !important;
  }

  .custom-order-modal-overlay * {
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  }

  .custom-order-modal {
    position: relative;
    background: #ffffff !important;
    border-radius: 12px;
    max-width: 480px;
    width: 100%;
    max-height: 90vh;
    min-height: 600px;
    overflow: hidden;
    transform: scale(0.95);
    transition: transform 0.2s ease;
    display: flex;
    flex-direction: column;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    z-index: 2147483647;
    font-size: 14px;
    line-height: 1.5;
    color: #111827;
  }

  .custom-order-modal-overlay.active .custom-order-modal {
    transform: scale(1);
  }

  /* Header */
  .custom-order-modal-header {
    display: flex;
    flex-direction: column;
    padding: 16px 20px 12px;
    border-bottom: 1px solid #f3f4f6;
    background: #ffffff;
    flex-shrink: 0;
  }

  .custom-order-modal-header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .custom-order-modal-title {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #111827;
    line-height: 1.4;
  }

  .custom-order-modal-close {
    background: transparent;
    border: none;
    padding: 6px;
    cursor: pointer;
    color: #9ca3af;
    border-radius: 8px;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .custom-order-modal-close:hover {
    background: #f3f4f6;
    color: #374151;
  }

  .custom-order-modal-close svg {
    width: 20px;
    height: 20px;
  }

  /* Progress Steps */
  .custom-order-progress {
    position: relative;
    padding: 0;
  }

  .custom-order-progress-line {
    position: absolute;
    top: 12px;
    left: 0;
    right: 0;
    height: 2px;
    background: #e5e7eb;
    border-radius: 2px;
  }

  .custom-order-progress-fill {
    position: absolute;
    top: 12px;
    left: 0;
    height: 2px;
    background: #22c55e;
    border-radius: 2px;
    transition: width 0.3s ease;
  }

  .custom-order-progress-steps {
    position: relative;
    display: flex;
    justify-content: space-between;
  }

  .custom-order-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
  }

  .custom-order-step-dot {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 700;
    transition: all 0.2s ease;
    border: 2px solid #d1d5db;
    background: #ffffff;
    color: #9ca3af;
  }

  .custom-order-step-dot.current {
    background: #111827;
    border-color: #111827;
    color: #ffffff;
    box-shadow: 0 0 0 4px rgba(17, 24, 39, 0.1);
  }

  .custom-order-step-dot.completed {
    background: #22c55e;
    border-color: #22c55e;
    color: #ffffff;
  }

  .custom-order-step-dot.current.completed {
    background: #22c55e;
    border-color: #22c55e;
    box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.15);
  }

  .custom-order-step-dot svg {
    width: 14px;
    height: 14px;
  }

  .custom-order-step-label {
    margin-top: 6px;
    font-size: 10px;
    font-weight: 500;
    color: #6b7280;
    max-width: 50px;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .custom-order-step-label.current {
    color: #111827;
  }

  .custom-order-step-label.completed {
    color: #22c55e;
  }

  /* Modal Body */
  .custom-order-modal-body {
    padding: 0;
    overflow-y: auto;
    flex: 1;
    background: #ffffff;
  }

  .custom-order-content {
    padding: 24px 20px;
  }

  /* Loading & Error States */
  .custom-order-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 40px;
    color: #6b7280;
    gap: 16px;
  }

  .custom-order-loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid #e5e7eb;
    border-top-color: #111827;
    border-radius: 50%;
    animation: custom-order-spin 0.8s linear infinite;
  }

  .custom-order-loading span {
    font-size: 14px;
    color: #6b7280;
  }

  @keyframes custom-order-spin {
    to { transform: rotate(360deg); }
  }

  .custom-order-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 60px 40px;
    color: #dc2626;
  }

  .custom-order-error svg {
    width: 48px;
    height: 48px;
    margin-bottom: 16px;
    color: #fca5a5;
  }

  .custom-order-error p {
    margin: 0;
    font-size: 15px;
    color: #dc2626;
    font-weight: 500;
    line-height: 1.5;
  }

  /* Step Content */
  .custom-order-step-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .custom-order-field-title {
    font-size: 20px;
    font-weight: 700;
    color: #111827;
    margin: 0;
  }

  .custom-order-field-title .required {
    color: #ef4444;
    margin-left: 4px;
  }

  .custom-order-step-indicator {
    font-size: 12px;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Guide Image */
  .custom-order-guide-image {
    width: 100%;
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(to bottom, #f9fafb, #ffffff);
    border-radius: 12px;
    border: 1px solid #f3f4f6;
    margin-bottom: 20px;
    overflow: hidden;
  }

  .custom-order-guide-image img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    padding: 16px;
  }

  .custom-order-guide-image-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    color: #d1d5db;
  }

  .custom-order-guide-image-placeholder svg {
    width: 48px;
    height: 48px;
  }

  .custom-order-guide-image-placeholder span {
    font-size: 14px;
  }

  /* Instructions Card */
  .custom-order-instructions {
    background: #eff6ff;
    border: 1px solid #dbeafe;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
  }

  .custom-order-instructions-inner {
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }

  .custom-order-instructions-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #dbeafe;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .custom-order-instructions-icon svg {
    width: 16px;
    height: 16px;
    color: #2563eb;
  }

  .custom-order-instructions-content h4 {
    font-size: 14px;
    font-weight: 600;
    color: #1e3a8a;
    margin: 0 0 4px 0;
  }

  .custom-order-instructions-content p {
    font-size: 14px;
    color: #1e40af;
    margin: 0;
    line-height: 1.6;
  }

  .custom-order-instructions-range {
    font-size: 12px;
    color: #2563eb;
    font-weight: 500;
    margin-top: 8px;
  }

  /* Input Field */
  .custom-order-input-wrapper {
    margin-bottom: 8px;
  }

  .custom-order-input-label {
    font-size: 14px;
    font-weight: 500;
    color: #374151;
    margin-bottom: 8px;
    display: block;
  }

  .custom-order-input-container {
    position: relative;
  }

  .custom-order-input {
    width: 100%;
    padding: 14px 16px;
    padding-right: 40px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    font-size: 14px;
    color: #111827;
    transition: all 0.15s ease;
  }

  .custom-order-input:focus {
    outline: none;
    border-color: #111827;
    box-shadow: 0 0 0 2px rgba(17, 24, 39, 0.1);
    background: #ffffff;
  }

  .custom-order-input::placeholder {
    color: #9ca3af;
  }

  .custom-order-input-unit {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
    color: #9ca3af;
  }

  /* Options Step */
  .custom-order-options-header {
    text-align: center;
    margin-bottom: 20px;
  }

  .custom-order-options-subtitle {
    font-size: 12px;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 4px;
  }

  .custom-order-options-title {
    font-size: 20px;
    font-weight: 700;
    color: #111827;
    margin: 0 0 4px 0;
  }

  .custom-order-options-desc {
    font-size: 14px;
    color: #6b7280;
    margin: 0;
  }

  .custom-order-option-section {
    background: #f9fafb;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
  }

  .custom-order-option-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .custom-order-option-title {
    font-size: 14px;
    font-weight: 600;
    color: #111827;
    margin: 0;
  }

  .custom-order-option-title .required {
    color: #ef4444;
    margin-left: 4px;
  }

  .custom-order-option-clear {
    font-size: 12px;
    color: #dc2626;
    font-weight: 500;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
  }

  .custom-order-option-clear:hover {
    color: #b91c1c;
  }

  /* Fit Preference Grid */
  .custom-order-fit-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }

  .custom-order-fit-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px 4px;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s ease;
    min-height: 56px;
  }

  .custom-order-fit-option:hover {
    border-color: #d1d5db;
  }

  .custom-order-fit-option.selected {
    background: #111827;
    border-color: #111827;
    color: #ffffff;
  }

  .custom-order-fit-option span:first-child {
    font-size: 12px;
    font-weight: 500;
  }

  .custom-order-fit-option span:last-child {
    font-size: 10px;
    opacity: 0.7;
  }

  /* Collar/Custom Options Grid */
  .custom-order-image-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }

  .custom-order-image-option {
    background: #ffffff;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .custom-order-image-option:hover {
    border-color: #d1d5db;
  }

  .custom-order-image-option.selected {
    border-color: #111827;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .custom-order-image-option-img {
    width: 100%;
    height: 56px;
    border-radius: 8px;
    background: #f9fafb;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    margin-bottom: 6px;
  }

  .custom-order-image-option-img img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: 4px;
  }

  .custom-order-image-option-img span {
    font-size: 10px;
    color: #9ca3af;
  }

  .custom-order-image-option-label {
    font-size: 12px;
    font-weight: 500;
    color: #374151;
  }

  /* Stitching Notes */
  .custom-order-textarea {
    width: 100%;
    padding: 12px;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    color: #111827;
    resize: none;
    min-height: 64px;
    transition: all 0.15s ease;
  }

  .custom-order-textarea:focus {
    outline: none;
    border-color: #111827;
    box-shadow: 0 0 0 2px rgba(17, 24, 39, 0.1);
  }

  .custom-order-textarea::placeholder {
    color: #9ca3af;
  }

  /* Review Step */
  .custom-order-review-header {
    text-align: center;
    margin-bottom: 20px;
  }

  .custom-order-review-icon {
    width: 48px;
    height: 48px;
    margin: 0 auto 12px;
    border-radius: 50%;
    background: #dcfce7;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .custom-order-review-icon svg {
    width: 24px;
    height: 24px;
    color: #22c55e;
  }

  .custom-order-review-title {
    font-size: 20px;
    font-weight: 700;
    color: #111827;
    margin: 0 0 4px 0;
  }

  .custom-order-review-desc {
    font-size: 14px;
    color: #6b7280;
    margin: 0;
  }

  .custom-order-review-section {
    margin-bottom: 20px;
  }

  .custom-order-review-section-title {
    font-size: 14px;
    font-weight: 600;
    color: #111827;
    margin: 0 0 12px 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .custom-order-review-section-title svg {
    width: 16px;
    height: 16px;
    color: #6b7280;
  }

  .custom-order-review-table {
    background: #f9fafb;
    border-radius: 12px;
    overflow: hidden;
  }

  .custom-order-review-table table {
    width: 100%;
    font-size: 14px;
    border-collapse: collapse;
  }

  .custom-order-review-table thead tr {
    background: #f3f4f6;
  }

  .custom-order-review-table th {
    padding: 10px 16px;
    text-align: left;
    font-weight: 600;
    color: #374151;
  }

  .custom-order-review-table th:last-child {
    text-align: right;
  }

  .custom-order-review-table td {
    padding: 10px 16px;
    color: #374151;
    border-top: 1px solid #f3f4f6;
  }

  .custom-order-review-table td:last-child {
    text-align: right;
  }

  .custom-order-review-table tr:nth-child(even) td {
    background: #f9fafb;
  }

  .custom-order-review-table tr:nth-child(odd) td {
    background: #ffffff;
  }

  .custom-order-review-value {
    font-weight: 500;
    color: #111827;
  }

  .custom-order-review-empty {
    color: #9ca3af;
    font-style: italic;
  }

  .custom-order-review-add {
    font-size: 12px;
    color: #2563eb;
    font-weight: 500;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
  }

  .custom-order-review-add:hover {
    text-decoration: underline;
  }

  .custom-order-edit-options {
    width: 100%;
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 500;
    color: #374151;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s ease;
    margin-top: 16px;
  }

  .custom-order-edit-options:hover {
    background: #f9fafb;
  }

  /* Validation Error Styles */
  .custom-order-validation-error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 16px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }

  .custom-order-validation-error-icon {
    width: 20px;
    height: 20px;
    color: #dc2626;
    flex-shrink: 0;
    margin-top: 1px;
  }

  .custom-order-validation-error-content h4 {
    font-size: 14px;
    font-weight: 600;
    color: #991b1b;
    margin: 0 0 4px 0;
  }

  .custom-order-validation-error-content p {
    font-size: 13px;
    color: #b91c1c;
    margin: 0;
  }

  .custom-order-validation-error-content ul {
    margin: 8px 0 0 0;
    padding-left: 16px;
    font-size: 13px;
    color: #b91c1c;
  }

  .custom-order-validation-error-content li {
    margin-bottom: 4px;
  }

  .custom-order-review-table tr.error td {
    background: #fef2f2 !important;
  }

  .custom-order-review-table tr.error td:first-child {
    color: #dc2626;
  }

  .custom-order-review-missing {
    color: #dc2626 !important;
    font-weight: 500;
  }

  /* No Fields Message */
  .custom-order-no-fields {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 64px 24px;
    text-align: center;
  }

  .custom-order-no-fields-icon {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 16px;
  }

  .custom-order-no-fields-icon svg {
    width: 32px;
    height: 32px;
    color: #9ca3af;
  }

  .custom-order-no-fields p {
    color: #6b7280;
    margin: 0;
  }

  /* Footer */
  .custom-order-modal-footer {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px;
    border-top: 1px solid #f3f4f6;
    background: rgba(249, 250, 251, 0.5);
  }

  .custom-order-btn-back {
    padding: 10px 16px;
    font-size: 14px;
    font-weight: 500;
    color: #374151;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.15s ease;
  }

  .custom-order-btn-back:hover {
    background: #f9fafb;
  }

  .custom-order-btn-back svg {
    width: 16px;
    height: 16px;
  }

  .custom-order-btn-next {
    flex: 1;
    padding: 10px 16px;
    font-size: 14px;
    font-weight: 600;
    color: #ffffff;
    background: #111827;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.15s ease;
  }

  .custom-order-btn-next:hover {
    background: #1f2937;
  }

  .custom-order-btn-next.confirm {
    background: #22c55e;
  }

  .custom-order-btn-next.confirm:hover {
    background: #16a34a;
  }

  .custom-order-btn-next svg {
    width: 16px;
    height: 16px;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .custom-order-modal-overlay {
      padding: 0;
    }

    .custom-order-modal {
      width: 100%;
      max-width: 100%;
      max-height: 100%;
      height: 100%;
      border-radius: 0;
      min-height: 100%;
    }

    .custom-order-modal-header {
      padding: 12px 16px 12px;
    }

    .custom-order-content {
      padding: 20px 16px;
    }

    .custom-order-modal-footer {
      padding: 12px 16px;
    }

    .custom-order-step-label {
      max-width: 40px;
      font-size: 9px;
    }
  }
</style>

<div class="custom-order-button-wrapper" data-block-id="{{ block.id }}">
  <button 
    type="button" 
    class="custom-order-button"
    data-custom-order-trigger
    data-shop="{{ shop.permanent_domain }}"
    data-product-id="{{ product.id }}"
    aria-label="Custom Order"
  >
    <span data-button-icon></span>
    <span data-button-text>Custom Order</span>
  </button>
</div>

<!-- Modal Template -->
<div class="custom-order-modal-overlay" data-custom-order-modal="{{ block.id }}">
  <div class="custom-order-modal" role="dialog" aria-modal="true" aria-labelledby="custom-order-title-{{ block.id }}">
    <div class="custom-order-modal-header">
      <div class="custom-order-modal-header-top">
        <h2 class="custom-order-modal-title" id="custom-order-title-{{ block.id }}">Custom Measurements</h2>
        <button type="button" class="custom-order-modal-close" data-custom-order-close aria-label="Close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="custom-order-progress" data-progress-container>
        <div class="custom-order-progress-line"></div>
        <div class="custom-order-progress-fill" data-progress-fill></div>
        <div class="custom-order-progress-steps" data-progress-steps>
          <!-- Steps will be populated dynamically -->
        </div>
      </div>
    </div>
    <div class="custom-order-modal-body" data-custom-order-content>
      <!-- Content will be loaded dynamically -->
    </div>
    <div class="custom-order-modal-footer" data-custom-order-footer>
      <!-- Footer buttons will be populated dynamically -->
    </div>
  </div>
</div>

<script>
  (function() {
    const blockId = "{{ block.id }}";
    const wrapper = document.querySelector(`[data-block-id="${blockId}"]`);
    const button = wrapper?.querySelector('[data-custom-order-trigger]');
    let modal = document.querySelector(`[data-custom-order-modal="${blockId}"]`);
    
    if (!button || !modal) return;

    // Move modal to body to escape stacking contexts
    if (modal.parentElement !== document.body) {
      document.body.appendChild(modal);
    }

    const closeBtn = modal.querySelector('[data-custom-order-close]');
    const contentContainer = modal.querySelector('[data-custom-order-content]');
    const footerContainer = modal.querySelector('[data-custom-order-footer]');
    const progressContainer = modal.querySelector('[data-progress-container]');
    const progressFill = modal.querySelector('[data-progress-fill]');
    const progressSteps = modal.querySelector('[data-progress-steps]');
    const buttonIconSpan = button.querySelector('[data-button-icon]');
    const buttonTextSpan = button.querySelector('[data-button-text]');

    const shop = button.dataset.shop;
    const productId = button.dataset.productId;

    // Theme settings
    const themeSettings = {
      alignment: "{{ block.settings.button_alignment | default: 'left' }}",
      marginTop: "{{ block.settings.button_margin_top | default: '10' }}",
      marginBottom: "{{ block.settings.button_margin_bottom | default: '10' }}",
      paddingVertical: "{{ block.settings.button_padding_vertical | default: '10' }}",
      paddingHorizontal: "{{ block.settings.button_padding_horizontal | default: '20' }}",
      buttonText: "{{ block.settings.button_text | default: 'Custom Order' }}",
      buttonTextColor: "{{ block.settings.button_text_color | default: '#ffffff' }}",
      buttonBgColor: "{{ block.settings.button_bg_color | default: '#111111' }}",
      buttonBorderRadius: "{{ block.settings.button_border_radius | default: '6' }}",
    };
    
    let isLoaded = false;
    let templateData = null;
    let currentStep = 0;
    let measurementValues = {};
    let selectedFit = null;
    let selectedCollar = null;
    let selectedCustomOptions = {};
    let stitchingNotes = "";

    // Icon SVGs
    const icons = {
      ruler: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z"/>
        <path d="m14.5 12.5 2-2"/><path d="m11.5 9.5 2-2"/><path d="m8.5 6.5 2-2"/><path d="m17.5 15.5 2-2"/>
      </svg>`,
      scissors: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="6" cy="6" r="3"/><path d="M8.12 8.12 12 12"/><path d="M20 4 8.12 15.88"/>
        <circle cx="6" cy="18" r="3"/><path d="M14.8 14.8 20 20"/>
      </svg>`,
      shirt: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20.38 3.46 16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23Z"/>
      </svg>`,
      checkIcon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 13l4 4L19 7"/></svg>`,
    };

    // Apply button settings
    function applyButtonSettings() {
      buttonTextSpan.textContent = themeSettings.buttonText;
      button.setAttribute('aria-label', themeSettings.buttonText);
      buttonIconSpan.innerHTML = icons.scissors;

      const alignment = themeSettings.alignment === 'center' ? 'center' : 
                        themeSettings.alignment === 'right' ? 'flex-end' : 'flex-start';
      wrapper.style.display = 'flex';
      wrapper.style.justifyContent = alignment;

      wrapper.style.marginTop = themeSettings.marginTop + 'px';
      wrapper.style.marginBottom = themeSettings.marginBottom + 'px';

      button.style.color = themeSettings.buttonTextColor;
      button.style.backgroundColor = themeSettings.buttonBgColor;
      button.style.borderRadius = themeSettings.buttonBorderRadius + 'px';
      button.style.padding = `${themeSettings.paddingVertical}px ${themeSettings.paddingHorizontal}px`;
      button.style.border = 'none';
    }

    // Render loading state
    function renderLoading() {
      progressContainer.style.display = 'none';
      contentContainer.innerHTML = `
        <div class="custom-order-loading">
          <div class="custom-order-loading-spinner"></div>
          <span>Loading custom order form...</span>
        </div>
      `;
      footerContainer.innerHTML = '';
    }

    // Render error state
    function renderError(message) {
      progressContainer.style.display = 'none';
      contentContainer.innerHTML = `
        <div class="custom-order-error">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
          <p>${message || 'No custom order template available for this product.'}</p>
        </div>
      `;
      footerContainer.innerHTML = '';
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Get template fields
    function getEnabledFields() {
      return templateData?.fields?.filter(f => f.enabled !== false) || [];
    }

    // Check if template has advanced options
    function hasAdvancedOptions() {
      if (!templateData) return false;
      const hasFit = templateData.fitPreferences && templateData.fitPreferences.filter(f => f.enabled).length > 0;
      const hasCollar = templateData.collarOptions && templateData.collarOptions.filter(c => c.enabled).length > 0;
      const hasCustom = templateData.customFeatures && templateData.customFeatures.filter(f => f.enabled && f.options?.length > 0).length > 0;
      const hasNotes = templateData.enableStitchingNotes;
      return hasFit || hasCollar || hasCustom || hasNotes;
    }

    // Calculate total steps
    function getTotalSteps() {
      const measurementSteps = getEnabledFields().length;
      const advancedStep = hasAdvancedOptions() ? 1 : 0;
      const reviewStep = 1;
      return measurementSteps + advancedStep + reviewStep;
    }

    // Get current step info
    function getStepInfo(stepIndex) {
      const enabledFields = getEnabledFields();
      const totalMeasurementSteps = enabledFields.length;
      const hasAdvanced = hasAdvancedOptions();
      const advancedStep = hasAdvanced ? 1 : 0;
      const totalSteps = getTotalSteps();

      return {
        isMeasurementStep: stepIndex < totalMeasurementSteps,
        isAdvancedStep: hasAdvanced && stepIndex === totalMeasurementSteps,
        isReviewStep: stepIndex === totalMeasurementSteps + advancedStep,
        currentField: enabledFields[stepIndex] || null,
        totalSteps: totalSteps,
        measurementSteps: totalMeasurementSteps,
      };
    }

    // Render progress steps
    function renderProgress() {
      const enabledFields = getEnabledFields();
      const hasAdvanced = hasAdvancedOptions();
      const totalSteps = getTotalSteps();

      if (totalSteps === 0) {
        progressContainer.style.display = 'none';
        return;
      }

      progressContainer.style.display = 'block';
      const progressPercent = (currentStep / (totalSteps - 1)) * 100;
      progressFill.style.width = `${progressPercent}%`;

      let stepsHtml = '';
      
      // Measurement steps
      enabledFields.forEach((field, index) => {
        const hasValue = measurementValues[field.name] && measurementValues[field.name].trim() !== '';
        const isCurrent = index === currentStep;
        const dotClass = isCurrent ? (hasValue ? 'current completed' : 'current') : (hasValue ? 'completed' : '');
        const labelClass = isCurrent ? 'current' : (hasValue ? 'completed' : '');
        
        stepsHtml += `
          <button class="custom-order-step" data-step="${index}" title="${escapeHtml(field.name)}">
            <span class="custom-order-step-dot ${dotClass}">
              ${hasValue ? icons.checkIcon : `<span>${index + 1}</span>`}
            </span>
            <span class="custom-order-step-label ${labelClass}">${escapeHtml(field.name)}</span>
          </button>
        `;
      });

      // Options step
      if (hasAdvanced) {
        const optionsIndex = enabledFields.length;
        const hasSelectedOptions = selectedFit || selectedCollar || Object.keys(selectedCustomOptions).length > 0 || stitchingNotes.trim();
        const isCurrent = currentStep === optionsIndex;
        const dotClass = isCurrent ? (hasSelectedOptions ? 'current completed' : 'current') : (hasSelectedOptions ? 'completed' : '');
        const labelClass = isCurrent ? 'current' : (hasSelectedOptions ? 'completed' : '');
        
        stepsHtml += `
          <button class="custom-order-step" data-step="${optionsIndex}" title="Options">
            <span class="custom-order-step-dot ${dotClass}">
              ${hasSelectedOptions ? icons.checkIcon : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>`}
            </span>
            <span class="custom-order-step-label ${labelClass}">Options</span>
          </button>
        `;
      }

      // Review step
      const reviewIndex = enabledFields.length + (hasAdvanced ? 1 : 0);
      const isCurrent = currentStep === reviewIndex;
      const dotClass = isCurrent ? 'current' : '';
      const labelClass = isCurrent ? 'current' : '';
      
      stepsHtml += `
        <button class="custom-order-step" data-step="${reviewIndex}" title="Review">
          <span class="custom-order-step-dot ${dotClass}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>
          </span>
          <span class="custom-order-step-label ${labelClass}">Review</span>
        </button>
      `;

      progressSteps.innerHTML = stepsHtml;

      // Add click handlers to steps
      progressSteps.querySelectorAll('.custom-order-step').forEach(stepBtn => {
        stepBtn.addEventListener('click', (e) => {
          const stepIndex = parseInt(stepBtn.dataset.step);
          if (!isNaN(stepIndex)) {
            validationErrors = []; // Clear validation errors when navigating via steps
            currentStep = stepIndex;
            renderContent();
          }
        });
      });
    }

    // Render measurement step
    function renderMeasurementStep(field) {
      const stepInfo = getStepInfo(currentStep);
      
      contentContainer.innerHTML = `
        <div class="custom-order-content">
          <div class="custom-order-step-header">
            <h3 class="custom-order-field-title">
              ${escapeHtml(field.name)}
              ${field.required ? '<span class="required">*</span>' : ''}
            </h3>
            <span class="custom-order-step-indicator">Step ${currentStep + 1} of ${stepInfo.totalSteps}</span>
          </div>

          <div class="custom-order-guide-image">
            ${field.image ? `<img src="${escapeHtml(field.image)}" alt="How to measure ${escapeHtml(field.name)}">` : `
              <div class="custom-order-guide-image-placeholder">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                  <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span>No guide image</span>
              </div>
            `}
          </div>

          <div class="custom-order-instructions">
            <div class="custom-order-instructions-inner">
              <div class="custom-order-instructions-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <div class="custom-order-instructions-content">
                <h4>How to Measure</h4>
                <p>${escapeHtml(field.instruction || 'Follow the guide image to take this measurement.')}</p>
                ${field.range ? `<p class="custom-order-instructions-range">Expected range: ${escapeHtml(field.range)} ${escapeHtml(field.unit || 'in')}</p>` : ''}
              </div>
            </div>
          </div>

          <div class="custom-order-input-wrapper">
            <label class="custom-order-input-label">Enter your measurement (${escapeHtml(field.unit || 'in')})</label>
            <div class="custom-order-input-container">
              <input 
                type="text" 
                class="custom-order-input" 
                placeholder="Enter value"
                value="${escapeHtml(measurementValues[field.name] || '')}"
                data-field-name="${escapeHtml(field.name)}"
              >
              <span class="custom-order-input-unit">${escapeHtml(field.unit || 'in')}</span>
            </div>
          </div>
        </div>
      `;

      // Add input listener
      const input = contentContainer.querySelector('.custom-order-input');
      input?.addEventListener('input', (e) => {
        measurementValues[field.name] = e.target.value;
        renderProgress();
      });
    }

    // Render advanced options step
    function renderAdvancedStep() {
      let optionsHtml = `
        <div class="custom-order-content">
          <div class="custom-order-options-header">
            <p class="custom-order-options-subtitle">Final Step</p>
            <h3 class="custom-order-options-title">Additional Options</h3>
            <p class="custom-order-options-desc">Customize your order preferences</p>
          </div>
      `;

      // Fit Preferences
      const fitPrefs = templateData.fitPreferences?.filter(f => f.enabled) || [];
      if (fitPrefs.length > 0) {
        const fitRequired = templateData.fitPreferenceRequired;
        optionsHtml += `
          <div class="custom-order-option-section">
            <div class="custom-order-option-header">
              <h4 class="custom-order-option-title">Fit Preference${fitRequired ? '<span class="required">*</span>' : ''}</h4>
              ${selectedFit ? `<button class="custom-order-option-clear" data-clear="fit">Clear</button>` : ''}
            </div>
            <div class="custom-order-fit-grid">
              ${fitPrefs.map(fit => `
                <div class="custom-order-fit-option ${selectedFit === fit.id ? 'selected' : ''}" data-fit-id="${fit.id}">
                  <span>${escapeHtml(fit.label)}</span>
                  <span>(${escapeHtml(fit.allowance)})</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      // Stitching Notes
      if (templateData.enableStitchingNotes) {
        const notesRequired = templateData.stitchingNotesRequired;
        optionsHtml += `
          <div class="custom-order-option-section">
            <h4 class="custom-order-option-title">Stitching Notes${notesRequired ? '<span class="required">*</span>' : ''}</h4>
            <textarea class="custom-order-textarea" placeholder="Add any specific instructions for the tailor..." data-stitching-notes>${escapeHtml(stitchingNotes)}</textarea>
          </div>
        `;
      }

      // Collar Options
      const collarOpts = templateData.collarOptions?.filter(c => c.enabled) || [];
      if (collarOpts.length > 0) {
        const collarRequired = templateData.collarOptionRequired;
        optionsHtml += `
          <div class="custom-order-option-section">
            <div class="custom-order-option-header">
              <h4 class="custom-order-option-title">Collar Style${collarRequired ? '<span class="required">*</span>' : ''}</h4>
              ${selectedCollar ? `<button class="custom-order-option-clear" data-clear="collar">Clear</button>` : ''}
            </div>
            <div class="custom-order-image-grid">
              ${collarOpts.map(collar => `
                <div class="custom-order-image-option ${selectedCollar === collar.id ? 'selected' : ''}" data-collar-id="${collar.id}">
                  <div class="custom-order-image-option-img">
                    ${collar.image ? `<img src="${escapeHtml(collar.image)}" alt="${escapeHtml(collar.name)}">` : `<span>No Image</span>`}
                  </div>
                  <span class="custom-order-image-option-label">${escapeHtml(collar.name)}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      // Custom Features
      const customFeatures = templateData.customFeatures?.filter(f => f.enabled && f.options?.length > 0) || [];
      customFeatures.forEach(feature => {
        const featureRequired = feature.required;
        optionsHtml += `
          <div class="custom-order-option-section">
            <div class="custom-order-option-header">
              <h4 class="custom-order-option-title">${escapeHtml(feature.name)}${featureRequired ? '<span class="required">*</span>' : ''}</h4>
              ${selectedCustomOptions[feature.id] ? `<button class="custom-order-option-clear" data-clear="custom" data-feature-id="${feature.id}">Clear</button>` : ''}
            </div>
            <div class="custom-order-image-grid">
              ${feature.options.map(option => `
                <div class="custom-order-image-option ${selectedCustomOptions[feature.id] === option.id ? 'selected' : ''}" data-feature-id="${feature.id}" data-option-id="${option.id}">
                  <div class="custom-order-image-option-img">
                    ${option.image ? `<img src="${escapeHtml(option.image)}" alt="${escapeHtml(option.name)}">` : `<span>No Image</span>`}
                  </div>
                  <span class="custom-order-image-option-label">${escapeHtml(option.name || 'Unnamed')}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });

      optionsHtml += '</div>';
      contentContainer.innerHTML = optionsHtml;

      // Add event listeners
      // Fit preferences
      contentContainer.querySelectorAll('[data-fit-id]').forEach(el => {
        el.addEventListener('click', () => {
          const fitId = el.dataset.fitId;
          selectedFit = selectedFit === fitId ? null : fitId;
          renderContent();
        });
      });

      // Collar options
      contentContainer.querySelectorAll('[data-collar-id]').forEach(el => {
        el.addEventListener('click', () => {
          const collarId = parseInt(el.dataset.collarId);
          selectedCollar = selectedCollar === collarId ? null : collarId;
          renderContent();
        });
      });

      // Custom options
      contentContainer.querySelectorAll('[data-feature-id][data-option-id]').forEach(el => {
        el.addEventListener('click', () => {
          const featureId = el.dataset.featureId;
          const optionId = el.dataset.optionId;
          if (selectedCustomOptions[featureId] === optionId) {
            delete selectedCustomOptions[featureId];
          } else {
            selectedCustomOptions[featureId] = optionId;
          }
          renderContent();
        });
      });

      // Stitching notes
      const notesTextarea = contentContainer.querySelector('[data-stitching-notes]');
      notesTextarea?.addEventListener('input', (e) => {
        stitchingNotes = e.target.value;
        renderProgress();
      });

      // Clear buttons
      contentContainer.querySelectorAll('[data-clear]').forEach(el => {
        el.addEventListener('click', (e) => {
          e.stopPropagation();
          const clearType = el.dataset.clear;
          if (clearType === 'fit') selectedFit = null;
          else if (clearType === 'collar') selectedCollar = null;
          else if (clearType === 'custom') delete selectedCustomOptions[el.dataset.featureId];
          renderContent();
        });
      });
    }

    // Render review step
    function renderReviewStep() {
      const enabledFields = getEnabledFields();
      const hasAdvanced = hasAdvancedOptions();
      
      // Helper to check if a field has a validation error
      const hasError = (fieldName) => validationErrors.some(e => e.field === fieldName);

      let reviewHtml = `
        <div class="custom-order-content">
          <div class="custom-order-review-header">
            <div class="custom-order-review-icon" ${validationErrors.length > 0 ? 'style="background:#fef2f2"' : ''}>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" ${validationErrors.length > 0 ? 'style="color:#dc2626"' : ''}>
                ${validationErrors.length > 0 
                  ? '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>'
                  : '<path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>'
                }
              </svg>
            </div>
            <h3 class="custom-order-review-title">${validationErrors.length > 0 ? 'Please Complete Required Fields' : 'Review Your Order'}</h3>
            <p class="custom-order-review-desc">${validationErrors.length > 0 ? 'The following fields are required to continue' : 'Please verify all details before adding to cart'}</p>
          </div>
      `;

      // Show validation errors if any
      if (validationErrors.length > 0) {
        reviewHtml += `
          <div class="custom-order-validation-error">
            <svg class="custom-order-validation-error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <div class="custom-order-validation-error-content">
              <h4>Missing Required Fields</h4>
              <p>Please fill in all required fields marked with <span style="color:#ef4444">*</span></p>
              <ul>
                ${validationErrors.map(err => `<li>${escapeHtml(err.field)}</li>`).join('')}
              </ul>
            </div>
          </div>
        `;
      }

      // Measurements table
      if (enabledFields.length > 0) {
        reviewHtml += `
          <div class="custom-order-review-section">
            <h4 class="custom-order-review-section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
              </svg>
              Measurements
            </h4>
            <div class="custom-order-review-table">
              <table>
                <thead>
                  <tr>
                    <th>Measurement</th>
                    <th>Value</th>
                  </tr>
                </thead>
                <tbody>
                  ${enabledFields.map((field, index) => {
                    const value = measurementValues[field.name];
                    const hasValue = value && value.trim() !== '';
                    const isError = hasError(field.name);
                    return `
                      <tr class="${isError ? 'error' : ''}">
                        <td>${escapeHtml(field.name)}${field.required ? '<span style="color:#ef4444">*</span>' : ''}</td>
                        <td>
                          ${hasValue 
                            ? `<span class="custom-order-review-value">${escapeHtml(value)} ${escapeHtml(field.unit || 'in')}</span>`
                            : `<button class="custom-order-review-add ${isError ? 'custom-order-review-missing' : ''}" data-goto-step="${index}">${isError ? 'Required - Add value' : '+ Add value'}</button>`
                          }
                        </td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      // Additional options summary
      if (hasAdvanced) {
        const fitPrefs = templateData.fitPreferences?.filter(f => f.enabled) || [];
        const collarOpts = templateData.collarOptions?.filter(c => c.enabled) || [];
        const customFeatures = templateData.customFeatures?.filter(f => f.enabled && f.options?.length > 0) || [];

        reviewHtml += `
          <div class="custom-order-review-section">
            <h4 class="custom-order-review-section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
              </svg>
              Additional Options
            </h4>
            <div class="custom-order-review-table">
              <table>
                <tbody>
        `;

        if (fitPrefs.length > 0) {
          const selectedFitObj = fitPrefs.find(f => f.id === selectedFit);
          const isFitError = hasError('Fit Preference');
          reviewHtml += `
            <tr class="${isFitError ? 'error' : ''}">
              <td>Fit Preference${templateData.fitPreferenceRequired ? '<span style="color:#ef4444">*</span>' : ''}</td>
              <td>
                ${selectedFitObj 
                  ? `<span class="custom-order-review-value">${escapeHtml(selectedFitObj.label)}</span>`
                  : `<span class="${isFitError ? 'custom-order-review-missing' : 'custom-order-review-empty'}">${isFitError ? 'Required - Not selected' : 'Not selected'}</span>`
                }
              </td>
            </tr>
          `;
        }

        if (templateData.enableStitchingNotes) {
          const isNotesError = hasError('Stitching Notes');
          reviewHtml += `
            <tr class="${isNotesError ? 'error' : ''}">
              <td>Stitching Notes${templateData.stitchingNotesRequired ? '<span style="color:#ef4444">*</span>' : ''}</td>
              <td>
                ${stitchingNotes.trim() 
                  ? `<span class="custom-order-review-value" style="max-width:150px;display:inline-block;overflow:hidden;text-overflow:ellipsis">${escapeHtml(stitchingNotes)}</span>`
                  : `<span class="${isNotesError ? 'custom-order-review-missing' : 'custom-order-review-empty'}">${isNotesError ? 'Required - None' : 'None'}</span>`
                }
              </td>
            </tr>
          `;
        }

        if (collarOpts.length > 0) {
          const selectedCollarObj = collarOpts.find(c => c.id === selectedCollar);
          const isCollarError = hasError('Collar Style');
          reviewHtml += `
            <tr class="${isCollarError ? 'error' : ''}">
              <td>Collar Style${templateData.collarOptionRequired ? '<span style="color:#ef4444">*</span>' : ''}</td>
              <td>
                ${selectedCollarObj 
                  ? `<span class="custom-order-review-value">${escapeHtml(selectedCollarObj.name)}</span>`
                  : `<span class="${isCollarError ? 'custom-order-review-missing' : 'custom-order-review-empty'}">${isCollarError ? 'Required - Not selected' : 'Not selected'}</span>`
                }
              </td>
            </tr>
          `;
        }

        customFeatures.forEach(feature => {
          const selectedOption = feature.options.find(o => o.id === selectedCustomOptions[feature.id]);
          const isFeatureError = hasError(feature.name);
          reviewHtml += `
            <tr class="${isFeatureError ? 'error' : ''}">
              <td>${escapeHtml(feature.name)}${feature.required ? '<span style="color:#ef4444">*</span>' : ''}</td>
              <td>
                ${selectedOption 
                  ? `<span class="custom-order-review-value">${escapeHtml(selectedOption.name)}</span>`
                  : `<span class="${isFeatureError ? 'custom-order-review-missing' : 'custom-order-review-empty'}">${isFeatureError ? 'Required - Not selected' : 'Not selected'}</span>`
                }
              </td>
            </tr>
          `;
        });

        reviewHtml += `
                </tbody>
              </table>
            </div>
            <button class="custom-order-edit-options" data-goto-options>Edit Options</button>
          </div>
        `;
      }

      reviewHtml += '</div>';
      contentContainer.innerHTML = reviewHtml;

      // Add event listeners
      contentContainer.querySelectorAll('[data-goto-step]').forEach(el => {
        el.addEventListener('click', () => {
          validationErrors = []; // Clear validation errors when navigating
          currentStep = parseInt(el.dataset.gotoStep);
          renderContent();
        });
      });

      const editOptionsBtn = contentContainer.querySelector('[data-goto-options]');
      editOptionsBtn?.addEventListener('click', () => {
        validationErrors = []; // Clear validation errors when navigating
        currentStep = getEnabledFields().length;
        renderContent();
      });
    }

    // Render footer
    function renderFooter() {
      const stepInfo = getStepInfo(currentStep);
      const totalSteps = stepInfo.totalSteps;

      let footerHtml = '';

      // Back button (not on first step or review step)
      if (currentStep > 0 && !stepInfo.isReviewStep) {
        footerHtml += `
          <button class="custom-order-btn-back" data-action="back">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 19l-7-7 7-7"/>
            </svg>
            Back
          </button>
        `;
      }

      // Next/Review/Confirm button
      if (stepInfo.isReviewStep) {
        footerHtml += `
          <button class="custom-order-btn-next confirm" data-action="confirm">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
            Confirm & Add to Cart
          </button>
        `;
      } else if (currentStep === totalSteps - 2) {
        footerHtml += `
          <button class="custom-order-btn-next" data-action="next">
            Review Order
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 5l7 7-7 7"/>
            </svg>
          </button>
        `;
      } else {
        footerHtml += `
          <button class="custom-order-btn-next" data-action="next">
            Save & Continue
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 5l7 7-7 7"/>
            </svg>
          </button>
        `;
      }

      footerContainer.innerHTML = footerHtml;

      // Add event listeners
      footerContainer.querySelector('[data-action="back"]')?.addEventListener('click', () => {
        validationErrors = []; // Clear validation errors when navigating back
        currentStep = Math.max(0, currentStep - 1);
        renderContent();
      });

      footerContainer.querySelector('[data-action="next"]')?.addEventListener('click', () => {
        validationErrors = []; // Clear validation errors when navigating forward
        currentStep = Math.min(totalSteps - 1, currentStep + 1);
        renderContent();
      });

      footerContainer.querySelector('[data-action="confirm"]')?.addEventListener('click', () => {
        handleConfirm();
      });
    }

    // Validate required fields
    function validateRequiredFields() {
      const errors = [];
      const enabledFields = getEnabledFields();
      
      // Check required measurement fields
      enabledFields.forEach((field, index) => {
        if (field.required) {
          const value = measurementValues[field.name];
          if (!value || value.trim() === '') {
            errors.push({
              type: 'measurement',
              field: field.name,
              stepIndex: index,
              message: `${field.name} is required`
            });
          }
        }
      });

      // Check fit preference if required
      const fitPrefs = templateData?.fitPreferences?.filter(f => f.enabled) || [];
      if (fitPrefs.length > 0 && templateData?.fitPreferenceRequired && !selectedFit) {
        errors.push({
          type: 'option',
          field: 'Fit Preference',
          stepIndex: enabledFields.length,
          message: 'Fit Preference is required'
        });
      }

      // Check stitching notes if required
      if (templateData?.enableStitchingNotes && templateData?.stitchingNotesRequired && !stitchingNotes.trim()) {
        errors.push({
          type: 'option',
          field: 'Stitching Notes',
          stepIndex: enabledFields.length,
          message: 'Stitching Notes is required'
        });
      }

      // Check collar option if required
      const collarOpts = templateData?.collarOptions?.filter(c => c.enabled) || [];
      if (collarOpts.length > 0 && templateData?.collarOptionRequired && !selectedCollar) {
        errors.push({
          type: 'option',
          field: 'Collar Style',
          stepIndex: enabledFields.length,
          message: 'Collar Style is required'
        });
      }

      // Check custom features if required
      const customFeatures = templateData?.customFeatures?.filter(f => f.enabled && f.options?.length > 0) || [];
      customFeatures.forEach(feature => {
        if (feature.required && !selectedCustomOptions[feature.id]) {
          errors.push({
            type: 'option',
            field: feature.name,
            stepIndex: enabledFields.length,
            message: `${feature.name} is required`
          });
        }
      });

      return errors;
    }

    // Get validation errors for display
    let validationErrors = [];

    // Handle confirm action
    function handleConfirm() {
      // Validate required fields
      validationErrors = validateRequiredFields();
      
      if (validationErrors.length > 0) {
        // Re-render review step to show errors
        renderContent();
        return;
      }

      // All validations passed - prepare data for cart
      const orderData = {
        measurements: measurementValues,
        fitPreference: selectedFit,
        collarStyle: selectedCollar,
        customOptions: selectedCustomOptions,
        stitchingNotes: stitchingNotes,
      };

      console.log('Custom Order Data:', orderData);

      // Close modal and reset
      closeModal();

      // You can add custom cart integration here
      // For now, we'll just log the data
      alert('Custom order details saved! (See console for data)');
    }

    // Render content based on current step
    function renderContent() {
      const stepInfo = getStepInfo(currentStep);
      
      renderProgress();

      if (stepInfo.isMeasurementStep && stepInfo.currentField) {
        renderMeasurementStep(stepInfo.currentField);
      } else if (stepInfo.isAdvancedStep) {
        renderAdvancedStep();
      } else if (stepInfo.isReviewStep) {
        renderReviewStep();
      } else {
        // No fields
        contentContainer.innerHTML = `
          <div class="custom-order-no-fields">
            <div class="custom-order-no-fields-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
            </div>
            <p>No measurement fields available for this template.</p>
          </div>
        `;
      }

      renderFooter();
    }

    // Check if template exists
    async function checkTemplateExists() {
      try {
        const apiUrl = `/apps/size-guide/api/storefront/custom-order?shop=${encodeURIComponent(shop)}&productId=${encodeURIComponent(productId)}`;
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (response.ok && data.hasTemplate) {
          wrapper.classList.add('has-template');
          templateData = data.template;
          isLoaded = true;
        }
      } catch (error) {
        console.error('Error checking custom order template:', error);
      }
    }

    // Fetch template data
    async function fetchTemplate() {
      if (isLoaded && templateData) {
        renderContent();
        return;
      }

      renderLoading();

      try {
        const apiUrl = `/apps/size-guide/api/storefront/custom-order?shop=${encodeURIComponent(shop)}&productId=${encodeURIComponent(productId)}`;
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (!response.ok || !data.hasTemplate) {
          renderError(data.error || 'No custom order template available for this product.');
          return;
        }

        templateData = data.template;
        isLoaded = true;
        renderContent();
      } catch (error) {
        console.error('Error fetching custom order template:', error);
        renderError('Failed to load custom order form. Please try again.');
      }
    }

    // Open modal
    function openModal() {
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
      fetchTemplate();
      closeBtn?.focus();
    }

    // Close modal
    function closeModal() {
      modal.classList.remove('active');
      document.body.style.overflow = '';
      // Reset state
      currentStep = 0;
      measurementValues = {};
      selectedFit = null;
      selectedCollar = null;
      selectedCustomOptions = {};
      stitchingNotes = "";
      validationErrors = [];
      button.focus();
    }

    // Event listeners
    button.addEventListener('click', openModal);
    closeBtn?.addEventListener('click', closeModal);

    // Close on overlay click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('active')) {
        closeModal();
      }
    });

    // Theme editor: close modal on section/block changes
    function handleShopifyEditorEvent() {
      if (modal.classList.contains('active')) {
        closeModal();
      }
    }

    document.addEventListener('shopify:section:load', handleShopifyEditorEvent);
    document.addEventListener('shopify:section:select', handleShopifyEditorEvent);
    document.addEventListener('shopify:block:select', handleShopifyEditorEvent);
    document.addEventListener('shopify:block:deselect', handleShopifyEditorEvent);

    // Initialize
    applyButtonSettings();
    checkTemplateExists();
  })();
</script>

{% schema %}
{
  "name": "Custom Order Button",
  "target": "section",
  "enabled_on": {
    "templates": ["product"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Button Text"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Custom Order"
    },
    {
      "type": "header",
      "content": "Button Style"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Text color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "button_bg_color",
      "label": "Background color",
      "default": "#111111"
    },
    {
      "type": "range",
      "id": "button_border_radius",
      "label": "Border radius",
      "min": 0,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 6
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "button_alignment",
      "label": "Button alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left"
    },
    {
      "type": "range",
      "id": "button_margin_top",
      "label": "Top margin",
      "min": 0,
      "max": 40,
      "step": 2,
      "unit": "px",
      "default": 10
    },
    {
      "type": "range",
      "id": "button_margin_bottom",
      "label": "Bottom margin",
      "min": 0,
      "max": 40,
      "step": 2,
      "unit": "px",
      "default": 10
    },
    {
      "type": "range",
      "id": "button_padding_vertical",
      "label": "Vertical padding",
      "min": 4,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 10
    },
    {
      "type": "range",
      "id": "button_padding_horizontal",
      "label": "Horizontal padding",
      "min": 8,
      "max": 40,
      "step": 2,
      "unit": "px",
      "default": 20
    }
  ]
}
{% endschema %}
