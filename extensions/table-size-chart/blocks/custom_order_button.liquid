{% comment %}Custom Order Button Block{% endcomment %}
{{ 'custom-order.css' | asset_url | stylesheet_tag }}

<div class="custom-order-button-wrapper" data-block-id="{{ block.id }}">
  <button type="button" class="custom-order-button" data-custom-order-trigger data-shop="{{ shop.permanent_domain }}" data-product-id="{{ product.id }}" aria-label="Custom Order">
    <span data-button-icon></span>
    <span data-button-text>Custom Order</span>
  </button>
</div>

<div class="custom-order-modal-overlay" data-custom-order-modal="{{ block.id }}">
  <div class="custom-order-modal" role="dialog" aria-modal="true" aria-labelledby="custom-order-title-{{ block.id }}">
    <div class="custom-order-modal-header">
      <div class="custom-order-modal-header-top">
        <h2 class="custom-order-modal-title" id="custom-order-title-{{ block.id }}">Custom Measurements</h2>
        <button type="button" class="custom-order-modal-close" data-custom-order-close aria-label="Close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <div class="custom-order-progress" data-progress-container>
        <div class="custom-order-progress-line"></div>
        <div class="custom-order-progress-fill" data-progress-fill></div>
        <div class="custom-order-progress-steps" data-progress-steps></div>
      </div>
    </div>
    <div class="custom-order-modal-body" data-custom-order-content></div>
    <div class="custom-order-modal-footer" data-custom-order-footer></div>
    <div class="custom-order-discard-backdrop" data-discard-modal>
      <div class="custom-order-discard-modal" role="alertdialog" aria-modal="true">
        <div class="custom-order-discard-header">
          <div class="custom-order-discard-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div>
          <h3 class="custom-order-discard-title">Discard changes?</h3>
        </div>
        <p class="custom-order-discard-body">You have entered custom measurements and options. If you close now, your changes will be lost.</p>
        <div class="custom-order-discard-footer">
          <button type="button" class="custom-order-discard-cancel" data-discard-cancel>Keep editing</button>
          <button type="button" class="custom-order-discard-confirm" data-discard-confirm>Discard changes</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){var b="{{ block.id }}",w=document.querySelector('[data-block-id="'+b+'"]'),btn=w?.querySelector('[data-custom-order-trigger]'),m=document.querySelector('[data-custom-order-modal="'+b+'"]');if(!btn||!m)return;m.parentElement!==document.body&&document.body.appendChild(m);var cls=m.querySelector('[data-custom-order-close]'),cnt=m.querySelector('[data-custom-order-content]'),ftr=m.querySelector('[data-custom-order-footer]'),prg=m.querySelector('[data-progress-container]'),pf=m.querySelector('[data-progress-fill]'),ps=m.querySelector('[data-progress-steps]'),ico=btn.querySelector('[data-button-icon]'),txt=btn.querySelector('[data-button-text]'),db=m.querySelector('[data-discard-modal]'),dc=m.querySelector('[data-discard-cancel]'),dd=m.querySelector('[data-discard-confirm]'),sh=btn.dataset.shop,pi=btn.dataset.productId,ts={al:"{{ block.settings.button_alignment | default: 'left' }}",mt:"{{ block.settings.button_margin_top | default: '10' }}",mb:"{{ block.settings.button_margin_bottom | default: '10' }}",pv:"{{ block.settings.button_padding_vertical | default: '10' }}",ph:"{{ block.settings.button_padding_horizontal | default: '20' }}",bt:"{{ block.settings.button_text | default: 'Custom Order' }}",tc:"{{ block.settings.button_text_color | default: '#ffffff' }}",bg:"{{ block.settings.button_bg_color | default: '#111111' }}",br:"{{ block.settings.button_border_radius | default: '6' }}"},ld=!1,td=null,cs=0,mv={},sf=null,sc=null,so={},sn="",ve=[],stk='customMeasurementTemplates_'+sh,ic={s:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="6" cy="6" r="3"/><path d="M8.12 8.12 12 12"/><path d="M20 4 8.12 15.88"/><circle cx="6" cy="18" r="3"/><path d="M14.8 14.8 20 20"/></svg>',c:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7"/></svg>'};function gst(){try{var d=localStorage.getItem(stk);return d?JSON.parse(d):[]}catch(e){return[]}}function sst(t){try{localStorage.setItem(stk,JSON.stringify(t))}catch(e){console.error('Failed to save templates',e)}}function svt(n){var t=gst(),nt={id:Date.now().toString(),name:n,createdAt:new Date().toISOString(),measurements:JSON.parse(JSON.stringify(mv)),fitPreference:sf,collarStyle:sc,customOptions:JSON.parse(JSON.stringify(so)),stitchingNotes:sn};t.unshift(nt);if(t.length>10)t=t.slice(0,10);sst(t);return nt}function dlt(id){var t=gst().filter(function(x){return x.id!==id});sst(t)}function ldt(id){var t=gst().find(function(x){return x.id===id});if(!t)return!1;mv=JSON.parse(JSON.stringify(t.measurements||{}));sf=t.fitPreference||null;sc=t.collarStyle||null;so=JSON.parse(JSON.stringify(t.customOptions||{}));sn=t.stitchingNotes||'';return!0}function ab(){txt.textContent=ts.bt;btn.setAttribute('aria-label',ts.bt);ico.innerHTML=ic.s;var a=ts.al==='center'?'center':ts.al==='right'?'flex-end':'flex-start';w.style.display='flex';w.style.justifyContent=a;w.style.marginTop=ts.mt+'px';w.style.marginBottom=ts.mb+'px';btn.style.color=ts.tc;btn.style.backgroundColor=ts.bg;btn.style.borderRadius=ts.br+'px';btn.style.padding=ts.pv+'px '+ts.ph+'px';btn.style.border='none'}function rl(){prg.style.display='none';cnt.innerHTML='<div class="custom-order-loading"><div class="custom-order-loading-spinner"></div><span>Loading...</span></div>';ftr.innerHTML=''}function re(x){prg.style.display='none';cnt.innerHTML='<div class="custom-order-error"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><p>'+(x||'No custom order template available.')+'</p></div>';ftr.innerHTML=''}function eh(t){var d=document.createElement('div');d.textContent=t;return d.innerHTML}function gf(){return td?.fields?.filter(f=>f.enabled!==false)||[]}function ha(){if(!td)return!1;var hf=td.fitPreferences&&td.fitPreferences.filter(f=>f.enabled).length>0,hc=td.collarOptions&&td.collarOptions.filter(c=>c.enabled).length>0,hx=td.customFeatures&&td.customFeatures.filter(f=>f.enabled&&f.options?.length>0).length>0,hn=td.enableStitchingNotes;return hf||hc||hx||hn}function gt(){return gf().length+(ha()?1:0)+1}function gi(i){var ef=gf(),ms=ef.length,hd=ha(),as=hd?1:0;return{im:i<ms,ia:hd&&i===ms,ir:i===ms+as,cf:ef[i]||null,ts:gt(),ms:ms}}function rp(){var ef=gf(),hd=ha(),ts=gt();if(ts===0){prg.style.display='none';return}prg.style.display='block';pf.style.width=(cs/(ts-1))*100+'%';var h='';ef.forEach(function(f,i){var hv=mv[f.name]&&mv[f.name].trim()!=='',ic=i===cs,dc=ic?(hv?'current completed':'current'):(hv?'completed':''),lc=ic?'current':(hv?'completed':'');h+='<button class="custom-order-step" data-step="'+i+'" title="'+eh(f.name)+'"><span class="custom-order-step-dot '+dc+'">'+(hv?'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7"/></svg>':'<span>'+(i+1)+'</span>')+'</span><span class="custom-order-step-label '+lc+'">'+eh(f.name)+'</span></button>'});if(hd){var oi=ef.length,ho=sf||sc||Object.keys(so).length>0||sn.trim(),ic=cs===oi,dc=ic?(ho?'current completed':'current'):(ho?'completed':''),lc=ic?'current':(ho?'completed':'');h+='<button class="custom-order-step" data-step="'+oi+'" title="Options"><span class="custom-order-step-dot '+dc+'">'+(ho?'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7"/></svg>':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>')+'</span><span class="custom-order-step-label '+lc+'">Options</span></button>'}var ri=ef.length+(hd?1:0),ic=cs===ri,dc=ic?'current':'',lc=ic?'current':'';h+='<button class="custom-order-step" data-step="'+ri+'" title="Review"><span class="custom-order-step-dot '+dc+'"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg></span><span class="custom-order-step-label '+lc+'">Review</span></button>';ps.innerHTML=h;ps.querySelectorAll('.custom-order-step').forEach(function(s){s.addEventListener('click',function(){var i=parseInt(s.dataset.step);if(!isNaN(i)){ve=[];cs=i;rc()}})})}function rms(f){var si=gi(cs),st=gst(),ph='';if(cs===0&&st.length>0){ph='<div class="custom-order-saved-templates"><button class="custom-order-load-btn" data-show-templates><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Previous Measurements ('+st.length+')</button></div>'}cnt.innerHTML='<div class="custom-order-content">'+ph+'<div class="custom-order-step-header"><h3 class="custom-order-field-title">'+eh(f.name)+(f.required?'<span class="required">*</span>':'')+'</h3><span class="custom-order-step-indicator">Step '+(cs+1)+' of '+si.ts+'</span></div><div class="custom-order-guide-image">'+(f.image?'<img src="'+eh(f.image)+'" alt="How to measure '+eh(f.name)+'">':'<div class="custom-order-guide-image-placeholder"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg><span>No guide image</span></div>')+'</div><div class="custom-order-instructions"><div class="custom-order-instructions-inner"><div class="custom-order-instructions-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div><div class="custom-order-instructions-content"><h4>How to Measure</h4><p>'+eh(f.instruction||'Follow the guide image.')+'</p>'+(f.range?'<p class="custom-order-instructions-range">Expected range: '+eh(f.range)+' '+eh(f.unit||'in')+'</p>':'')+'</div></div></div><div class="custom-order-input-wrapper"><label class="custom-order-input-label">Enter your measurement ('+eh(f.unit||'in')+')</label><div class="custom-order-input-container"><input type="number" step="any" min="0" inputmode="decimal" class="custom-order-input" placeholder="Enter value" value="'+eh(mv[f.name]||'')+'" data-field-name="'+eh(f.name)+'" onkeypress="return (event.charCode>=48&&event.charCode<=57)||event.charCode==46||event.charCode==0"><span class="custom-order-input-unit">'+eh(f.unit||'in')+'</span></div></div></div>';var ip=cnt.querySelector('.custom-order-input');ip?.addEventListener('input',function(e){mv[f.name]=e.target.value;rp()});var stb=cnt.querySelector('[data-show-templates]');stb?.addEventListener('click',stm)}function ras(){var oh='<div class="custom-order-content"><div class="custom-order-options-header"><p class="custom-order-options-subtitle">Final Step</p><h3 class="custom-order-options-title">Additional Options</h3><p class="custom-order-options-desc">Customize your order preferences</p></div>',fp=td.fitPreferences?.filter(f=>f.enabled)||[];if(fp.length>0){oh+='<div class="custom-order-option-section"><div class="custom-order-option-header"><h4 class="custom-order-option-title">Fit Preference'+(td.fitPreferenceRequired?'<span class="required">*</span>':'')+'</h4>'+(sf?'<button class="custom-order-option-clear" data-clear="fit">Clear</button>':'')+'</div><div class="custom-order-fit-grid">'+fp.map(f=>'<div class="custom-order-fit-option '+(sf===f.id?'selected':'')+'" data-fit-id="'+f.id+'"><span>'+eh(f.label)+'</span><span>('+eh(f.allowance)+')</span></div>').join('')+'</div></div>'}if(td.enableStitchingNotes){oh+='<div class="custom-order-option-section"><h4 class="custom-order-option-title">Stitching Notes'+(td.stitchingNotesRequired?'<span class="required">*</span>':'')+'</h4><textarea class="custom-order-textarea" placeholder="Add any specific instructions..." data-stitching-notes>'+eh(sn)+'</textarea></div>'}var co=td.collarOptions?.filter(c=>c.enabled)||[];if(co.length>0){oh+='<div class="custom-order-option-section"><div class="custom-order-option-header"><h4 class="custom-order-option-title">Collar Style'+(td.collarOptionRequired?'<span class="required">*</span>':'')+'</h4>'+(sc?'<button class="custom-order-option-clear" data-clear="collar">Clear</button>':'')+'</div><div class="custom-order-image-grid">'+co.map(c=>'<div class="custom-order-image-option '+(sc===c.id?'selected':'')+'" data-collar-id="'+c.id+'"><div class="custom-order-image-option-img">'+(c.image?'<img src="'+eh(c.image)+'" alt="'+eh(c.name)+'">':'<span>No Image</span>')+'</div><span class="custom-order-image-option-label">'+eh(c.name)+'</span></div>').join('')+'</div></div>'}var cf=td.customFeatures?.filter(f=>f.enabled&&f.options?.length>0)||[];cf.forEach(function(f){oh+='<div class="custom-order-option-section"><div class="custom-order-option-header"><h4 class="custom-order-option-title">'+eh(f.name)+(f.required?'<span class="required">*</span>':'')+'</h4>'+(so[f.id]?'<button class="custom-order-option-clear" data-clear="custom" data-feature-id="'+f.id+'">Clear</button>':'')+'</div><div class="custom-order-image-grid">'+f.options.map(o=>'<div class="custom-order-image-option '+(String(so[f.id])===String(o.id)?'selected':'')+'" data-feature-id="'+f.id+'" data-option-id="'+o.id+'"><div class="custom-order-image-option-img">'+(o.image?'<img src="'+eh(o.image)+'" alt="'+eh(o.name)+'">':'<span>No Image</span>')+'</div><span class="custom-order-image-option-label">'+eh(o.name||'Unnamed')+'</span></div>').join('')+'</div></div>'});oh+='</div>';cnt.innerHTML=oh;cnt.querySelectorAll('[data-fit-id]').forEach(function(e){e.addEventListener('click',function(){sf=sf===e.dataset.fitId?null:e.dataset.fitId;rc()})});cnt.querySelectorAll('[data-collar-id]').forEach(function(e){e.addEventListener('click',function(){var id=parseInt(e.dataset.collarId);sc=sc===id?null:id;rc()})});cnt.querySelectorAll('[data-feature-id][data-option-id]').forEach(function(e){e.addEventListener('click',function(){var fi=String(e.dataset.featureId),oi=String(e.dataset.optionId);String(so[fi])===oi?delete so[fi]:so[fi]=oi;rc()})});var nt=cnt.querySelector('[data-stitching-notes]');nt?.addEventListener('input',function(e){sn=e.target.value;rp()});cnt.querySelectorAll('[data-clear]').forEach(function(e){e.addEventListener('click',function(ev){ev.stopPropagation();var ct=e.dataset.clear;if(ct==='fit')sf=null;else if(ct==='collar')sc=null;else if(ct==='custom')delete so[e.dataset.featureId];rc()})})}function stm(){var st=gst();if(st.length===0)return;var oh='<div class="custom-order-template-modal"><div class="custom-order-template-modal-content"><div class="custom-order-template-modal-header"><h3>Previous Measurements</h3><button class="custom-order-template-close" data-close-tpl><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class="custom-order-template-list">'+st.map(function(t){var dt=new Date(t.createdAt),ds=dt.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}),mc=Object.keys(t.measurements||{}).filter(function(k){return t.measurements[k]}).length;return'<div class="custom-order-template-item" data-tpl-id="'+t.id+'"><div class="custom-order-template-info"><div class="custom-order-template-name">'+eh(t.name)+'</div><div class="custom-order-template-meta">'+mc+' measurements • '+ds+'</div></div><div class="custom-order-template-actions"><button class="custom-order-template-use" data-use-tpl="'+t.id+'">Use</button><button class="custom-order-template-delete" data-del-tpl="'+t.id+'"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div></div>'}).join('')+'</div></div></div>';var tm=document.createElement('div');tm.innerHTML=oh;var md=tm.firstChild;document.body.appendChild(md);md.querySelector('[data-close-tpl]').addEventListener('click',function(){md.remove()});md.querySelectorAll('[data-use-tpl]').forEach(function(b){b.addEventListener('click',function(){var id=b.dataset.useTpl;if(ldt(id)){md.remove();rc()}})});md.querySelectorAll('[data-del-tpl]').forEach(function(b){b.addEventListener('click',function(e){e.stopPropagation();var id=b.dataset.delTpl,tn=b.closest('[data-tpl-id]')?.querySelector('.custom-order-template-name')?.textContent||'this template';sdm(id,tn,md)})})}function sdm(id,tn,pmd){var oh='<div class="custom-order-delete-modal"><div class="custom-order-delete-modal-content"><div class="custom-order-delete-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></div><h3 class="custom-order-delete-title">Delete Measurement?</h3><p class="custom-order-delete-desc">Are you sure you want to delete "<strong>'+eh(tn)+'</strong>"? This action cannot be undone.</p><div class="custom-order-delete-actions"><button class="custom-order-delete-cancel" data-cancel-del>Cancel</button><button class="custom-order-delete-confirm" data-confirm-del>Delete</button></div></div></div>';var dm=document.createElement('div');dm.innerHTML=oh;var dmd=dm.firstChild;document.body.appendChild(dmd);dmd.querySelector('[data-cancel-del]').addEventListener('click',function(){dmd.remove()});dmd.querySelector('[data-confirm-del]').addEventListener('click',function(){dlt(id);var it=pmd.querySelector('[data-tpl-id="'+id+'"]');it?.remove();dmd.remove();if(gst().length===0)pmd.remove()})}function ssm(){var oh='<div class="custom-order-template-modal"><div class="custom-order-template-modal-content save"><div class="custom-order-template-modal-header"><h3>Save Measurements</h3><button class="custom-order-template-close" data-close-save><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class="custom-order-save-form"><p class="custom-order-save-desc">Save your measurements for faster checkout next time.</p><label class="custom-order-save-label">Template Name</label><input type="text" class="custom-order-save-input" placeholder="e.g., My Shirt Measurements" data-tpl-name maxlength="50"><div class="custom-order-save-actions"><button class="custom-order-save-cancel" data-cancel-save>Cancel</button><button class="custom-order-save-confirm" data-confirm-save>Save</button></div></div></div></div>';var tm=document.createElement('div');tm.innerHTML=oh;var md=tm.firstChild;document.body.appendChild(md);var ni=md.querySelector('[data-tpl-name]');ni.focus();md.querySelector('[data-close-save]').addEventListener('click',function(){md.remove()});md.querySelector('[data-cancel-save]').addEventListener('click',function(){md.remove()});md.querySelector('[data-confirm-save]').addEventListener('click',function(){var n=ni.value.trim();if(!n){ni.style.borderColor='#ef4444';ni.focus();return}svt(n);md.remove();var tb=document.createElement('div');tb.className='custom-order-toast';tb.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>Measurements saved!';document.body.appendChild(tb);setTimeout(function(){tb.classList.add('show')},10);setTimeout(function(){tb.classList.remove('show');setTimeout(function(){tb.remove()},300)},2000)});ni.addEventListener('keypress',function(e){if(e.key==='Enter')md.querySelector('[data-confirm-save]').click()})}function rrs(){var ef=gf(),hd=ha(),he=function(fn){return ve.some(function(e){return e.field===fn})},hm=Object.values(mv).some(function(v){return v&&String(v).trim()!==''}),rh='<div class="custom-order-content"><div class="custom-order-review-header"><div class="custom-order-review-icon"'+(ve.length>0?' style="background:#fef2f2"':'')+'><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"'+(ve.length>0?' style="color:#dc2626"':'')+'>'+(ve.length>0?'<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>':'<path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>')+'</svg></div><h3 class="custom-order-review-title">'+(ve.length>0?'Please Complete Required Fields':'Review Your Order')+'</h3><p class="custom-order-review-desc">'+(ve.length>0?'The following fields are required':'Please verify all details before adding to cart')+'</p></div>'+(hm&&ve.length===0?'<button class="custom-order-save-template-btn" data-save-template><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg>Save for Later</button>':'');if(ve.length>0){rh+='<div class="custom-order-validation-error"><svg class="custom-order-validation-error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><div class="custom-order-validation-error-content"><h4>Missing Required Fields</h4><p>Please fill in all required fields marked with <span style="color:#ef4444">*</span></p><ul>'+ve.map(function(e){return'<li>'+eh(e.field)+'</li>'}).join('')+'</ul></div></div>'}if(ef.length>0){rh+='<div class="custom-order-review-section"><h4 class="custom-order-review-section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>Measurements</h4><div class="custom-order-review-table"><table><thead><tr><th>Measurement</th><th>Value</th></tr></thead><tbody>'+ef.map(function(f,i){var v=mv[f.name],hv=v&&v.trim()!=='',ie=he(f.name);return'<tr class="'+(ie?'error':'')+'"><td>'+eh(f.name)+(f.required?'<span style="color:#ef4444">*</span>':'')+'</td><td>'+(hv?'<span class="custom-order-review-value">'+eh(v)+' '+eh(f.unit||'in')+'</span>':'<button class="custom-order-review-add '+(ie?'custom-order-review-missing':'')+'" data-goto-step="'+i+'">'+(ie?'Required - Add value':'+ Add value')+'</button>')+'</td></tr>'}).join('')+'</tbody></table></div></div>'}if(hd){var fp=td.fitPreferences?.filter(function(f){return f.enabled})||[],co=td.collarOptions?.filter(function(c){return c.enabled})||[],cf=td.customFeatures?.filter(function(f){return f.enabled&&f.options?.length>0})||[];rh+='<div class="custom-order-review-section"><h4 class="custom-order-review-section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>Additional Options</h4><div class="custom-order-review-table"><table><tbody>';if(fp.length>0){var sfo=fp.find(function(f){return f.id===sf}),ife=he('Fit Preference');rh+='<tr class="'+(ife?'error':'')+'"><td>Fit Preference'+(td.fitPreferenceRequired?'<span style="color:#ef4444">*</span>':'')+'</td><td>'+(sfo?'<span class="custom-order-review-value">'+eh(sfo.label)+'</span>':'<span class="'+(ife?'custom-order-review-missing':'custom-order-review-empty')+'">'+(ife?'Required - Not selected':'Not selected')+'</span>')+'</td></tr>'}if(td.enableStitchingNotes){var ine=he('Stitching Notes');rh+='<tr class="'+(ine?'error':'')+'"><td>Stitching Notes'+(td.stitchingNotesRequired?'<span style="color:#ef4444">*</span>':'')+'</td><td>'+(sn.trim()?'<span class="custom-order-review-value" style="max-width:150px;display:inline-block;overflow:hidden;text-overflow:ellipsis">'+eh(sn)+'</span>':'<span class="'+(ine?'custom-order-review-missing':'custom-order-review-empty')+'">'+(ine?'Required - None':'None')+'</span>')+'</td></tr>'}if(co.length>0){var sco=co.find(function(c){return c.id===sc}),ice=he('Collar Style');rh+='<tr class="'+(ice?'error':'')+'"><td>Collar Style'+(td.collarOptionRequired?'<span style="color:#ef4444">*</span>':'')+'</td><td>'+(sco?'<span class="custom-order-review-value">'+eh(sco.name)+'</span>':'<span class="'+(ice?'custom-order-review-missing':'custom-order-review-empty')+'">'+(ice?'Required - Not selected':'Not selected')+'</span>')+'</td></tr>'}cf.forEach(function(f){var sop=f.options.find(function(o){return String(o.id)===String(so[f.id])}),ife=he(f.name);rh+='<tr class="'+(ife?'error':'')+'"><td>'+eh(f.name)+(f.required?'<span style="color:#ef4444">*</span>':'')+'</td><td>'+(sop?'<span class="custom-order-review-value">'+eh(sop.name)+'</span>':'<span class="'+(ife?'custom-order-review-missing':'custom-order-review-empty')+'">'+(ife?'Required - Not selected':'Not selected')+'</span>')+'</td></tr>'});rh+='</tbody></table></div><button class="custom-order-edit-options" data-goto-options>Edit Options</button></div>'}rh+='</div>';cnt.innerHTML=rh;cnt.querySelectorAll('[data-goto-step]').forEach(function(e){e.addEventListener('click',function(){ve=[];cs=parseInt(e.dataset.gotoStep);rc()})});var eo=cnt.querySelector('[data-goto-options]');eo?.addEventListener('click',function(){ve=[];cs=gf().length;rc()});var stb=cnt.querySelector('[data-save-template]');stb?.addEventListener('click',ssm)}function rf(){var si=gi(cs),ts=si.ts,fh='';if(cs>0&&!si.ir){fh+='<button class="custom-order-btn-back" data-action="back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 19l-7-7 7-7"/></svg>Back</button>'}if(si.ir){fh+='<button class="custom-order-btn-next confirm" data-action="confirm"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>Save & Checkout</button>'}else if(cs===ts-2){fh+='<button class="custom-order-btn-next" data-action="next">Review Order<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5l7 7-7 7"/></svg></button>'}else{fh+='<button class="custom-order-btn-next" data-action="next">Save & Continue<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5l7 7-7 7"/></svg></button>'}ftr.innerHTML=fh;ftr.querySelector('[data-action="back"]')?.addEventListener('click',function(){ve=[];cs=Math.max(0,cs-1);rc()});ftr.querySelector('[data-action="next"]')?.addEventListener('click',function(){ve=[];cs=Math.min(ts-1,cs+1);rc()});ftr.querySelector('[data-action="confirm"]')?.addEventListener('click',hc)}function vr(){var er=[],ef=gf();ef.forEach(function(f,i){if(f.required){var v=mv[f.name];if(!v||v.trim()==='')er.push({type:'measurement',field:f.name,stepIndex:i})}});var fp=td?.fitPreferences?.filter(function(f){return f.enabled})||[];if(fp.length>0&&td?.fitPreferenceRequired&&!sf)er.push({type:'option',field:'Fit Preference',stepIndex:ef.length});if(td?.enableStitchingNotes&&td?.stitchingNotesRequired&&!sn.trim())er.push({type:'option',field:'Stitching Notes',stepIndex:ef.length});var co=td?.collarOptions?.filter(function(c){return c.enabled})||[];if(co.length>0&&td?.collarOptionRequired&&!sc)er.push({type:'option',field:'Collar Style',stepIndex:ef.length});var cf=td?.customFeatures?.filter(function(f){return f.enabled&&f.options?.length>0})||[];cf.forEach(function(f){if(f.required&&!so[f.id])er.push({type:'option',field:f.name,stepIndex:ef.length})});return er}function huc(){var hm=Object.values(mv).some(function(v){return v&&String(v).trim()!==''}),hf=!!sf,hcl=!!sc,hco=Object.keys(so).length>0,hn=sn&&sn.trim()!=='';return hm||hf||hcl||hco||hn}function odm(){if(!db)return;db.classList.add('active')}function cdm(){if(!db)return;db.classList.remove('active')}function hac(){if(!huc()){cm();return}odm()}async function hc(){ve=vr();if(ve.length>0){rc();return}var od={measurements:mv,fitPreference:sf,collarStyle:sc,customOptions:so,stitchingNotes:sn};console.log('Custom Order Data:',od);await atc(od)}async function atc(od){try{var vi=null,pf=document.querySelector('form[action*="/cart/add"]');if(pf)vi=pf.querySelector('input[name="id"]')||pf.querySelector('select[name="id"]');if(!vi||!vi.value){vi=document.querySelector('input[name="id"][type="hidden"]')||document.querySelector('select[name="id"]')||document.querySelector('[data-product-variant-id]')||document.querySelector('input[name="id"]')}if(!vi||!vi.value){var pid='{{ product.selected_or_first_available_variant.id }}';if(pid&&pid!=='')vi={value:pid}}if(!vi||!vi.value){console.error('Custom order: unable to find variant id');alert('Unable to add to cart. Variant not found.');return}var fp=td?.fitPreferences?.find(function(f){return f.id===sf}),co=td?.collarOptions?.find(function(c){return c.id===sc}),cf=td?.customFeatures?.filter(function(f){return f.enabled&&f.options?.length>0})||[],pr={};Object.keys(od.measurements).forEach(function(k){if(od.measurements[k]&&String(od.measurements[k]).trim()!==''){var fld=gf().find(function(f){return f.name===k});pr[k]=od.measurements[k]+(fld?.unit?' '+fld.unit:' in')}});if(fp)pr['Fit Preference']=fp.label+(fp.allowance?' ('+fp.allowance+')':'');if(co)pr['Collar Style']=co.name;cf.forEach(function(f){var sop=f.options.find(function(o){return String(o.id)===String(so[f.id])});if(sop)pr[f.name]=sop.name});if(od.stitchingNotes&&od.stitchingNotes.trim())pr['Stitching Notes']=od.stitchingNotes;if(td&&typeof td.price==='number'&&td.price>0){var cur=td.currency||'USD',sym={'USD':'$','EUR':'€','GBP':'£','INR':'₹','CAD':'C$','AUD':'A$'}[cur]||cur+' ';pr['Custom Tailoring Fee']=sym+td.price.toFixed(2)+' '+cur}console.log('Adding to cart with properties:',pr);var bd={items:[{id:parseInt(vi.value),quantity:1,properties:pr}]};console.log('Cart request body:',JSON.stringify(bd));var rs=await fetch('/cart/add.js',{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(bd)});var rj=await rs.json();console.log('Cart response:',rj);if(!rs.ok){console.error('Cart add failed:',rj);alert('Failed to add to cart. Please try again.');return}if(rj.items&&rj.items[0]&&rj.items[0].properties){console.log('Properties saved:',rj.items[0].properties)}window.location.href='/checkout'}catch(e){console.error('Error adding to cart:',e);alert('An error occurred: '+e.message)}}function rc(){var si=gi(cs);rp();if(si.im&&si.cf)rms(si.cf);else if(si.ia)ras();else if(si.ir)rrs();else cnt.innerHTML='<div class="custom-order-no-fields"><div class="custom-order-no-fields-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg></div><p>No measurement fields available.</p></div>';rf()}async function ct(){try{var r=await fetch('/apps/size-guide/api/storefront/custom-order?shop='+encodeURIComponent(sh)+'&productId='+encodeURIComponent(pi)),d=await r.json();if(r.ok&&d.hasTemplate){w.classList.add('has-template');td=d.template;ld=!0}}catch(e){console.error('Error:',e)}}async function ft(){if(ld&&td){rc();return}rl();try{var r=await fetch('/apps/size-guide/api/storefront/custom-order?shop='+encodeURIComponent(sh)+'&productId='+encodeURIComponent(pi)),d=await r.json();if(!r.ok||!d.hasTemplate){re(d.error);return}td=d.template;ld=!0;rc()}catch(e){console.error('Error:',e);re('Failed to load.')}}function om(){m.classList.add('active');document.body.style.overflow='hidden';ft();cls?.focus()}function cm(){m.classList.remove('active');document.body.style.overflow='';cs=0;mv={};sf=null;sc=null;so={};sn='';ve=[];btn.focus()}btn.addEventListener('click',om);cls?.addEventListener('click',hac);dc?.addEventListener('click',cdm);dd?.addEventListener('click',function(){cdm();cm()});document.addEventListener('keydown',function(e){if(e.key==='Escape'&&m.classList.contains('active')){if(db&&db.classList.contains('active')){cdm();return}hac()}});function hse(){if(m.classList.contains('active'))cm()}document.addEventListener('shopify:section:load',hse);document.addEventListener('shopify:section:select',hse);document.addEventListener('shopify:block:select',hse);document.addEventListener('shopify:block:deselect',hse);ab();ct()})();
</script>

{% schema %}
{
  "name": "Custom Order Button",
  "target": "section",
  "enabled_on": {
    "templates": ["product"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Button Text"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Custom Order"
    },
    {
      "type": "header",
      "content": "Button Style"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Text color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "button_bg_color",
      "label": "Background color",
      "default": "#111111"
    },
    {
      "type": "range",
      "id": "button_border_radius",
      "label": "Border radius",
      "min": 0,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 6
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "button_alignment",
      "label": "Button alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left"
    },
    {
      "type": "range",
      "id": "button_margin_top",
      "label": "Top margin",
      "min": 0,
      "max": 40,
      "step": 2,
      "unit": "px",
      "default": 10
    },
    {
      "type": "range",
      "id": "button_margin_bottom",
      "label": "Bottom margin",
      "min": 0,
      "max": 40,
      "step": 2,
      "unit": "px",
      "default": 10
    },
    {
      "type": "range",
      "id": "button_padding_vertical",
      "label": "Vertical padding",
      "min": 4,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 10
    },
    {
      "type": "range",
      "id": "button_padding_horizontal",
      "label": "Horizontal padding",
      "min": 8,
      "max": 40,
      "step": 2,
      "unit": "px",
      "default": 20
    }
  ]
}
{% endschema %}
